<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trang Hướng dẫn viên - Travel Website</title>
    <script>
    // Ngăn chặn lỗi runtime.lastError
    window.addEventListener('error', function(e) {
        if (e && e.message && e.message.indexOf('runtime.lastError') > -1) {
            e.stopPropagation();
            e.stopImmediatePropagation();
            e.preventDefault();
            return false;
        }
    }, true);

    window.addEventListener('unhandledrejection', function(e) {
        if (e && e.reason && e.reason.message && e.reason.message.indexOf('runtime.lastError') > -1) {
            e.stopPropagation();
            e.stopImmediatePropagation();
            e.preventDefault();
            return false;
        }
    });

    // Kiểm tra token khi trang tải
    window.addEventListener('DOMContentLoaded', function() {
        const token = localStorage.getItem('token');
        const user = localStorage.getItem('user') ? JSON.parse(localStorage.getItem('user')) : null;
        
        if (!token || !user || (user.loai_tai_khoan !== 'Huong_dan_vien' && user.role !== 'Huong_dan_vien')) {
            window.location.href = '/login.html';
        }
    });
    </script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="css/style.css" rel="stylesheet">
    <link href="css/admin.css" rel="stylesheet">
    <link href="css/guide.css" rel="stylesheet">
    <style>
        html, body {
          overflow-x: hidden;
        }
        .main-content {
          padding: 20px;
          overflow-x: hidden;
        }
    </style>
</head>

<body>
    <div class="container-fluid px-0">
        <div class="row g-0">
            <!-- Sidebar -->
            <div class="col-auto p-0">
                <div class="sidebar">
                    <div class="text-center text-white mb-4">
                        <h4><i class="fas fa-user-tie"></i> Guide Portal</h4>
                    </div>
                    <nav class="nav flex-column">
                        <a class="nav-link active" href="#dashboard" id="navDashboard">
                            <i class="fas fa-chart-line"></i> Dashboard
                        </a>
                        <a class="nav-link" href="#schedules" id="navSchedules">
                            <i class="fas fa-calendar-alt"></i> Lịch của tôi
                        </a>
                        <a class="nav-link" href="#bookings" id="navBookings">
                            <i class="fas fa-users"></i> Booking
                        </a>
                        <a class="nav-link" href="#reviews" id="navReviews">
                            <i class="fas fa-star"></i> Đánh giá
                        </a>
                        <a class="nav-link" href="#profile" id="navProfile">
                            <i class="fas fa-user-circle"></i> Hồ sơ cá nhân
                        </a>
                        <a class="nav-link text-danger" href="#" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i> Đăng xuất
                        </a>
                    </nav>
                </div>
            </div>

            <!-- Main content -->
            <div class="col p-0">
                <div class="main-content">
                    <div class="admin-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h2 id="sectionTitle">Dashboard</h2>
                            <div class="user-info d-flex align-items-center">
                                <div class="position-relative me-3">
                                    <button class="btn btn-link text-white p-0 position-relative" id="notificationBell" type="button" data-bs-toggle="dropdown" style="font-size: 1.5rem;">
                                        <i class="fas fa-bell"></i>
                                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notificationBadge" style="display: none;">0</span>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end" id="notificationDropdown" style="min-width: 350px; max-height: 500px; overflow-y: auto;">
                                        <li><h6 class="dropdown-header">Thông báo</h6></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li id="notificationList">
                                            <div class="px-3 py-2 text-muted text-center">
                                                <small>Chưa có thông báo mới</small>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                                <span id="guideName" class="text-white"></span>
                                <img id="guideAvatar" src="" alt="Avatar" class="rounded-circle ms-2" style="width: 40px; height: 40px; object-fit: cover; display: none;">
                            </div>
                        </div>
                    </div>

                    <!-- Dashboard Section -->
                    <div id="dashboardSection" class="content-section">
                        <div class="row mb-4">
                            <!-- Stats Cards -->
                            <div class="col-md-3 mb-3">
                                <div class="card stat-card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="text-muted mb-2">Tổng số tour</h6>
                                                <h3 class="mb-0" id="statTotalTours">0</h3>
                                            </div>
                                            <div class="stat-icon bg-primary">
                                                <i class="fas fa-map-marked-alt"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card stat-card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="text-muted mb-2">Tổng booking</h6>
                                                <h3 class="mb-0" id="statTotalBookings">0</h3>
                                            </div>
                                            <div class="stat-icon bg-success">
                                                <i class="fas fa-calendar-check"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card stat-card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="text-muted mb-2">Đánh giá TB</h6>
                                                <h3 class="mb-0" id="statAvgRating">0.0</h3>
                                            </div>
                                            <div class="stat-icon bg-warning">
                                                <i class="fas fa-star"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card stat-card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="text-muted mb-2">Tổng khách</h6>
                                                <h3 class="mb-0" id="statTotalGuests">0</h3>
                                            </div>
                                            <div class="stat-icon bg-info">
                                                <i class="fas fa-users"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Upcoming Schedules -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-calendar-alt"></i> Lịch sắp tới</h5>
                            </div>
                            <div class="card-body">
                                <div id="upcomingSchedulesList">
                                    <div class="text-center text-muted py-4">
                                        <i class="fas fa-spinner fa-spin"></i> Đang tải...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Schedules Section -->
                    <div id="schedulesSection" class="content-section" style="display: none;">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-calendar-alt"></i> Lịch của tôi</h5>
                                <div>
                                    <select class="form-select form-select-sm d-inline-block" id="scheduleFilter" style="width: auto;">
                                        <option value="all">Tất cả</option>
                                        <option value="sap_dien_ra">Sắp diễn ra</option>
                                        <option value="dang_dien_ra">Đang diễn ra</option>
                                        <option value="da_dien_ra">Đã diễn ra</option>
                                    </select>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover" id="schedulesTable">
                                        <thead>
                                            <tr>
                                                <th>Mã lịch</th>
                                                <th>Tên tour</th>
                                                <th>Ngày bắt đầu</th>
                                                <th>Ngày kết thúc</th>
                                                <th>Số chỗ</th>
                                                <th>Số booking</th>
                                                <th>Trạng thái</th>
                                                <th>Thao tác</th>
                                            </tr>
                                        </thead>
                                        <tbody id="schedulesTableBody">
                                            <tr>
                                                <td colspan="8" class="text-center">
                                                    <i class="fas fa-spinner fa-spin"></i> Đang tải...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Bookings Section -->
                    <div id="bookingsSection" class="content-section" style="display: none;">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-users"></i> Chi tiết Booking</h5>
                                <button class="btn btn-sm btn-primary" id="exportBookingsBtn" style="display: none;">
                                    <i class="fas fa-file-excel"></i> Xuất Excel
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="bookingDetailsContent">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle"></i> Vui lòng chọn một lịch để xem chi tiết booking
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Reviews Section -->
                    <div id="reviewsSection" class="content-section" style="display: none;">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-star"></i> Đánh giá</h5>
                                <div>
                                    <select class="form-select form-select-sm d-inline-block" id="reviewFilter" style="width: auto;">
                                        <option value="all">Tất cả</option>
                                        <option value="5">5 sao</option>
                                        <option value="4">4 sao</option>
                                        <option value="3">3 sao</option>
                                        <option value="2">2 sao</option>
                                        <option value="1">1 sao</option>
                                    </select>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="reviewsList">
                                    <div class="text-center text-muted py-4">
                                        <i class="fas fa-spinner fa-spin"></i> Đang tải...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Profile Section -->
                    <div id="profileSection" class="content-section" style="display: none;">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-user-circle"></i> Hồ sơ cá nhân</h5>
                            </div>
                            <div class="card-body">
                                <form id="profileForm">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Tên hướng dẫn viên *</label>
                                            <input type="text" class="form-control" id="profileTen" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Ngày sinh *</label>
                                            <input type="date" class="form-control" id="profileNgaySinh" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Giới tính *</label>
                                            <select class="form-select" id="profileGioiTinh" required>
                                                <option value="Nam">Nam</option>
                                                <option value="Nữ">Nữ</option>
                                                <option value="Khác">Khác</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Số điện thoại *</label>
                                            <input type="tel" class="form-control" id="profileSoDienThoai" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">CCCD *</label>
                                            <input type="text" class="form-control" id="profileCccd" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Địa chỉ</label>
                                            <input type="text" class="form-control" id="profileDiaChi">
                                        </div>
                                        <div class="col-md-12 mb-3">
                                            <label class="form-label">Ngôn ngữ</label>
                                            <input type="text" class="form-control" id="profileNgonNgu" placeholder="VD: Tiếng Việt, English, 中文">
                                        </div>
                                        <div class="col-md-12 mb-3">
                                            <label class="form-label">Kinh nghiệm</label>
                                            <textarea class="form-control" id="profileKinhNghiem" rows="3"></textarea>
                                        </div>
                                        <div class="col-md-12 mb-3">
                                            <label class="form-label">Chứng chỉ</label>
                                            <div class="certificate-upload-section">
                                                <div class="mb-3">
                                                    <label class="form-label">Thêm chứng chỉ mới</label>
                                                    <div class="input-group">
                                                        <input type="text" class="form-control" id="certificateName" placeholder="Tên chứng chỉ (VD: Chứng chỉ hướng dẫn viên quốc tế)">
                                                        <select class="form-select" id="certificateType" style="max-width: 200px;">
                                                            <option value="">Loại chứng chỉ</option>
                                                            <option value="Quốc tế">Quốc tế</option>
                                                            <option value="Nội địa">Nội địa</option>
                                                            <option value="Ngoại ngữ">Ngoại ngữ</option>
                                                            <option value="Chuyên môn">Chuyên môn</option>
                                                            <option value="Khác">Khác</option>
                                                        </select>
                                                    </div>
                                                    <div class="input-group mt-2">
                                                        <input type="text" class="form-control" id="certificateIssuer" placeholder="Nơi cấp">
                                                        <input type="date" class="form-control" id="certificateIssueDate" placeholder="Ngày cấp" onchange="validateCertificateDates()">
                                                        <input type="date" class="form-control" id="certificateExpiryDate" placeholder="Ngày hết hạn (tùy chọn)" onchange="validateCertificateDates()">
                                                    </div>
                                                    <div class="invalid-feedback d-block" id="certificateDateError" style="display: none; color: #dc3545; font-size: 0.875rem; margin-top: 0.25rem;">
                                                        <i class="fas fa-exclamation-circle"></i> Ngày cấp phải nhỏ hơn Ngày hết hạn
                                                    </div>
                                                    <div class="mt-2">
                                                        <input type="file" class="form-control" id="certificateFile" accept=".pdf,.jpg,.jpeg,.png,.gif,.webp">
                                                        <small class="text-muted">Chấp nhận file PDF hoặc hình ảnh (tối đa 10MB)</small>
                                                    </div>
                                                    <button type="button" class="btn btn-primary btn-sm mt-2" id="addCertificateBtn">
                                                        <i class="fas fa-plus"></i> Thêm chứng chỉ
                                                    </button>
                                                </div>
                                                <div id="certificatesList" class="certificates-list">
                                                    <div class="text-center text-muted py-3">
                                                        <i class="fas fa-spinner fa-spin"></i> Đang tải...
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-12 mb-3">
                                            <label class="form-label">Ảnh đại diện</label>
                                            <input type="file" class="form-control" id="profileAnhDaiDien" accept="image/*">
                                            <small class="text-muted">Chỉ chấp nhận file hình ảnh (JPG, PNG, GIF)</small>
                                            <div id="profileAvatarPreview" class="mt-2"></div>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Lưu thay đổi
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
        <div id="toastNotification" class="toast" role="alert">
            <div class="toast-header">
                <strong class="me-auto">Thông báo</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastBody"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="js/config.js"></script>
    <script src="js/guide.js"></script>
</body>
</html>

