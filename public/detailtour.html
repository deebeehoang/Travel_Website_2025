<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>X√°c Nh·∫≠n ƒê·∫∑t Tour - VietTravel</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">
  <!-- SweetAlert2 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css">
  <!-- Custom CSS -->
  <link rel="stylesheet" href="css/style.css">
  <!-- Th√™m v√†o head -->
<link rel="stylesheet" href="css/detailtour.css">

</head>
<body>
  <!-- Navigation -->

  
  <div id="navbar-container"></div>

  <!-- Tour Header Banner - Hero Image -->
  <div id="tour-banner" class="tour-header-banner">
    <div class="tour-banner-overlay"></div>
  </div>

  <!-- Main Content -->
  <div class="container mt-5 mb-5">
    <!-- Th√¥ng b√°o l·ªói -->
    <div id="booking-error" class="container mt-5 py-4 d-none">
      <div class="alert alert-danger mb-4">
        <h4 class="alert-heading"><span id="error-message">C√≥ l·ªói x·∫£y ra</span></h4>
        <p class="mb-0">Kh√¥ng th·ªÉ hi·ªÉn th·ªã th√¥ng tin ƒë·∫∑t tour. Vui l√≤ng th·ª≠ l·∫°i sau.</p>
      </div>
      <div class="text-center mt-4">
        <a href="index.html" class="btn btn-primary"><i class="fas fa-home me-2"></i> Quay l·∫°i trang ch·ªß</a>
        <a href="alltour.html" class="btn btn-outline-primary ms-2"><i class="fas fa-list me-2"></i> Xem t·∫•t c·∫£ tour</a>
      </div>
    </div>

    <div id="booking-content" class="row">
      <!-- Tour Information - Left Column -->
      <div class="col-md-7">
        <!-- Tour Title and Price -->
        <div class="tour-title-section mb-4">
          <h1 id="tour-title" class="tour-main-title">ƒêang t·∫£i th√¥ng tin tour...</h1>
          <div id="tour-price-display" class="tour-price-large d-none">
            <span id="tour-price-value">0</span> VNƒê
          </div>
        </div>

        <!-- L·ªãch tr√¨nh t√≥m t·∫Øt v·ªõi Rating -->
        <div class="card shadow-sm mb-4">
          <div class="card-body p-4 card-body-rating">
            <div class="d-flex align-items-center justify-content-between mb-3">
              <div class="rating-display">
                <span class="rating-score" id="tour-rating-score">5.0</span>
                <span class="rating-total">/5.0</span>
                <div class="rating-stars mb-2">
                  <i class="fas fa-star text-warning"></i>
                  <i class="fas fa-star text-warning"></i>
                  <i class="fas fa-star text-warning"></i>
                  <i class="fas fa-star text-warning"></i>
                  <i class="fas fa-star text-warning"></i>
                </div>
                <span class="rating-count" id="tour-rating-count">159+ ƒë√°nh gi√°</span>
              </div>
            </div>
            <div id="summary-itinerary">
              <div class="text-center text-muted py-3">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">ƒêang t·∫£i l·ªãch tr√¨nh...</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Chi ti·∫øt Tour - 4 Boxes -->
        <div class="row mb-4">
          <div class="col-md-6 mb-3">
            <div class="detail-box">
              <div class="detail-box-icon">
                <i class="fas fa-calendar-alt"></i>
              </div>
              <div class="detail-box-content">
                <h6 class="detail-box-title">Ng√†y Kh·ªüi H√†nh</h6>
                <p class="detail-box-text" id="departure-date">ƒêang t·∫£i...</p>
              </div>
              <div class="detail-box-check d-none" id="departure-check">
                <i class="fas fa-check-circle"></i>
              </div>
            </div>
          </div>
          <div class="col-md-6 mb-3">
            <div class="detail-box">
              <div class="detail-box-icon">
                <i class="fas fa-clock"></i>
              </div>
              <div class="detail-box-content">
                <h6 class="detail-box-title">Th·ªùi Gian & ƒê·ªãa ƒêi·ªÉm</h6>
                <p class="detail-box-text" id="time-location">ƒêang t·∫£i...</p>
              </div>
            </div>
          </div>
          <div class="col-md-6 mb-3">
            <div class="detail-box">
              <div class="detail-box-icon">
                <i class="fas fa-file-contract"></i>
              </div>
              <div class="detail-box-content">
                <h6 class="detail-box-title">ƒêi·ªÅu Kho·∫£n & B·∫£o ƒê·∫£m</h6>
                <p class="detail-box-text">Ch√≠nh s√°ch h·ªßy tour linh ho·∫°t</p>
              </div>
            </div>
          </div>
          <div class="col-md-6 mb-3">
            <div class="detail-box">
              <div class="detail-box-icon">
                <i class="fas fa-dollar-sign"></i>
              </div>
              <div class="detail-box-content">
                <h6 class="detail-box-title">Gi√° ƒê√£ Bao G·ªìm</h6>
                <p class="detail-box-text" id="price-includes">ƒêang t·∫£i...</p>
              </div>
              <div class="detail-box-check d-none" id="price-check">
                <i class="fas fa-check-circle"></i>
              </div>
            </div>
          </div>
        </div>

        <!-- Th√¥ng tin tour chi ti·∫øt -->
        <div class="card shadow-sm mb-4">
          <div class="card-body p-4 card-body-info">
            <h5 class="card-section-title mb-4"><i class="fas fa-info-circle me-2"></i>Th√¥ng Tin Tour</h5>
            <div id="tour-details">
              <div class="skeleton-loader mb-3" style="height: 30px;"></div>
              <div class="skeleton-loader mb-3" style="height: 20px;"></div>
              <div class="skeleton-loader mb-3" style="height: 20px;"></div>
              <div class="skeleton-loader mb-3" style="height: 100px;"></div>
            </div>
          </div>
        </div>

        <!-- L·ªãch tr√¨nh chi ti·∫øt -->
        <div class="card shadow-sm mb-4">
          <div class="card-body p-4 card-body-schedule">
            <h5 class="card-section-title mb-4"><i class="fas fa-calendar-alt me-2"></i>L·ªãch Tr√¨nh Chi Ti·∫øt</h5>
            <div id="schedule-details">
              <div class="skeleton-loader mb-3" style="height: 30px;"></div>
              <div class="skeleton-loader mb-3" style="height: 20px;"></div>
            </div>
          </div>
        </div>

        <!-- ƒêi·ªÉm ƒë·∫øn -->
        <div class="card shadow-sm mb-4">
          <div class="card-body p-4 card-body-destinations">
            <h5 class="card-section-title mb-4"><i class="fas fa-map-marker-alt me-2"></i>ƒêi·ªÉm ƒê·∫øn</h5>
            <div id="destinations-list">
              <div class="skeleton-loader mb-3" style="height: 100px;"></div>
            </div>
          </div>
        </div>

        <!-- ƒê√°nh gi√° kh√°ch h√†ng -->
        <div class="card shadow-sm mb-4">
          <div class="card-body p-4 card-body-reviews">
            <h5 class="card-section-title mb-4"><i class="fas fa-star me-2"></i>ƒê√°nh Gi√° Kh√°ch H√†ng</h5>
            <div id="tour-ratings">
              <div class="skeleton-loader mb-3" style="height: 100px;"></div>
            </div>
          </div>
        </div>

        <!-- Tour li√™n quan -->
        <div class="card shadow-sm mb-4">
          <div class="card-body p-4 card-body-related">
            <h5 class="card-section-title mb-4"><i class="fas fa-map-marked-alt me-2"></i>Tour Li√™n Quan</h5>
            <div id="related-tours" class="row">
              <div class="col-12 text-center text-muted py-3">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">ƒêang t·∫£i...</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Booking Form - Right Column -->
      <div class="col-md-5">
        <!-- Form ƒê·∫∑t Tour -->
        <div class="card shadow-sm mb-4 booking-form-card">
          <div class="card-header booking-form-header">
            <h4 class="m-0"><i class="fas fa-calendar-check me-2"></i>Form ƒê·∫∑t Tour</h4>
          </div>
          <div class="card-body p-4 card-body-booking">
            <div id="customer-info-not-logged" class="alert alert-warning d-none">
              <i class="fas fa-exclamation-triangle me-2"></i> Vui l√≤ng 
              <a href="login.html?redirect=booking-confirm.html" class="alert-link">ƒëƒÉng nh·∫≠p</a> 
              ƒë·ªÉ ti·∫øp t·ª•c ƒë·∫∑t tour.
            </div>

            <form id="booking-form">
              <input type="hidden" id="ma_tour" name="ma_tour">
              <input type="hidden" id="ma_lich_khoi_hanh" name="ma_lich_khoi_hanh">
              
              <div id="customer-info-form">
                <div class="mb-3">
                  <label for="ten_khach_hang" class="form-label">H·ªç v√† t√™n <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="ten_khach_hang" name="ten_khach_hang" required>
                </div>
                
                <div class="mb-3">
                  <label for="ngay_sinh" class="form-label">Ng√†y sinh <span class="text-danger">*</span></label>
                  <input type="date" class="form-control" id="ngay_sinh" name="ngay_sinh" required>
                </div>
                
                <div class="mb-3">
                  <label for="gioi_tinh" class="form-label">Gi·ªõi t√≠nh <span class="text-danger">*</span></label>
                  <select class="form-select" id="gioi_tinh" name="gioi_tinh" required>
                    <option value="">-- Ch·ªçn gi·ªõi t√≠nh --</option>
                    <option value="Nam">Nam</option>
                    <option value="N·ªØ">N·ªØ</option>
                    <option value="Kh√°c">Kh√°c</option>
                  </select>
                </div>
                
                <div class="mb-3">
                  <label for="dia_chi" class="form-label">ƒê·ªãa ch·ªâ <span class="text-danger">*</span></label>
                  <textarea class="form-control" id="dia_chi" name="dia_chi" rows="2" required></textarea>
                </div>
                
                <div class="mb-3">
                  <label for="cccd" class="form-label">CƒÉn c∆∞·ªõc c√¥ng d√¢n <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="cccd" name="cccd" required 
                    pattern="[0-9]{9}|[0-9]{12}" title="CCCD ph·∫£i c√≥ 9 ho·∫∑c 12 s·ªë">
                </div>
              </div>

              <hr>
              
              <div class="mb-3">
                <label for="so_nguoi_lon" class="form-label">S·ªë ng∆∞·ªùi l·ªõn <span class="text-danger">*</span></label>
                <input type="number" class="form-control booking-count" id="so_nguoi_lon" name="so_nguoi_lon" min="1" value="1" required>
              </div>
              
              <div class="mb-3">
                <label for="so_tre_em" class="form-label">S·ªë tr·∫ª em</label>
                <input type="number" class="form-control booking-count" id="so_tre_em" name="so_tre_em" min="0" value="0">
              </div>
              
              <div class="mb-3">
                <label for="ma_khuyen_mai" class="form-label">M√£ khuy·∫øn m√£i</label>
                <div class="input-group">
                  <input type="text" class="form-control" id="ma_khuyen_mai" name="ma_khuyen_mai">
                  <button class="btn btn-outline-primary" type="button" id="check-promo">Ki·ªÉm tra</button>
                </div>
                <div id="promo-result" class="form-text"></div>
              </div>
              
              <div class="card bg-light mt-4 mb-4">
                <div class="card-body">
                  <h5 class="card-title">T√≥m t·∫Øt ƒë∆°n h√†ng</h5>
                  <div id="booking-summary">
                    <div class="d-flex justify-content-between mb-2">
                      <span>Ng∆∞·ªùi l·ªõn:</span>
                      <span id="adult-summary">x 1</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                      <span>Tr·∫ª em:</span>
                      <span id="child-summary">x 0</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between fw-bold">
                      <span>T·ªïng c·ªông:</span>
                      <span id="total-price">0 VNƒê</span>
                    </div>
                  </div>
                </div>
              </div>
              <hr>
              <div class="mb-3">
                <label class="form-label">D·ªãch v·ª• b·ªï sung</label>
                <div id="extraServices">
                  <!-- Danh s√°ch d·ªãch v·ª• s·∫Ω ƒë∆∞·ª£c load ·ªü ƒë√¢y b·∫±ng JavaScript -->
                </div>
              </div>

              <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary btn-lg" id="submit-booking-btn">
                  <i class="fas fa-cart-plus me-2"></i>ƒê·∫∑t Tour
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Ph∆∞∆°ng th·ª©c thanh to√°n -->
        <div class="card shadow-sm mb-4">
          <div class="card-body p-4 card-body-payment">
            <h5 class="card-section-title mb-4"><i class="fas fa-credit-card me-2"></i>Ph∆∞∆°ng Th·ª©c Thanh To√°n</h5>
            <div class="payment-methods">
              <div class="payment-method-item">
                <i class="fas fa-credit-card payment-icon"></i>
                <span>Th·∫ª t√≠n d·ª•ng</span>
              </div>
              <div class="payment-method-item">
                <i class="fas fa-university payment-icon"></i>
                <span>Chuy·ªÉn kho·∫£n</span>
              </div>
              <div class="payment-method-item">
                <i class="fas fa-wallet payment-icon"></i>
                <span>V√≠ ƒëi·ªán t·ª≠</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="text-center mt-5 mb-5">
    <a href="index.html" class="btn btn-outline-secondary btn-lg">
      <i class="fas fa-arrow-left me-2"></i> Quay v·ªÅ trang ch·ªß
    </a>
  </div>
  
  <!-- Footer -->
  <div id="footer-container"></div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>
  <script src="js/config.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/main.js"></script>
  <script src="js/client/booking.js"></script>
  <script src="js/navbar.js"></script>
  <!-- Chatbox CSS -->
  <link rel="stylesheet" href="css/chatbox.css">
  <!-- Chatbox JS -->
  <script src="js/chatbox.js"></script>
  <script>
    // H√†m helper ƒë·ªÉ th·ª±c hi·ªán API request v·ªõi token
    async function apiRequest(endpoint, options = {}) {
      const token = localStorage.getItem('token');
      const headers = {
        'Content-Type': 'application/json',
        ...options.headers
      };
      
      // Th√™m token v√†o headers n·∫øu c√≥
      if (token) {
        headers['Authorization'] = `Bearer ${token}`;
      }
      
      const requestOptions = {
        method: options.method || 'GET',
        headers: headers,
        ...options
      };
      
      // X√≥a headers kh·ªèi options ƒë·ªÉ tr√°nh tr√πng l·∫∑p
      delete requestOptions.headers;
      requestOptions.headers = headers;
      
      try {
        const response = await fetch(`${window.API_URL}${endpoint}`, requestOptions);
        
        if (!response.ok) {
          // N·∫øu l√† l·ªói 401 Unauthorized, c√≥ th·ªÉ token h·∫øt h·∫°n
          if (response.status === 401) {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            // C√≥ th·ªÉ th√™m logic ƒë·ªÉ redirect v·ªÅ trang login
          }
          
          const errorData = await response.json().catch(() => ({
            status: 'error',
            message: `HTTP error ${response.status}: ${response.statusText}`
          }));
          
          throw new Error(errorData.message || `HTTP error ${response.status}`);
        }
        
        return await response.json();
      } catch (error) {
        console.error(`API request error for ${endpoint}:`, error);
        throw error;
      }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
      // Load navbar and footer
      loadNavbar();
      loadFooter();
      
      // Setup navbar scroll effect
      setupNavbarScrollEffect();
      
      // Check if user is logged in
      if (!isLoggedIn()) {
        document.getElementById('booking-error').classList.remove('d-none');
        document.getElementById('customer-info-not-logged').classList.remove('d-none');
        document.getElementById('submit-booking-btn').disabled = true;
      } else {
        // Fetch user profile and fill customer info if available
        fetchUserProfile().then(data => {
          if (data && data.data && data.data.user && data.data.user.details) {
            const customer = data.data.user.details;
            document.getElementById('ten_khach_hang').value = customer.Ten_khach_hang || '';
            if (customer.Ngay_sinh) {
              const dateParts = new Date(customer.Ngay_sinh);
              document.getElementById('ngay_sinh').value = dateParts.toISOString().split('T')[0];
            }
            document.getElementById('gioi_tinh').value = customer.Gioi_tinh || '';
            document.getElementById('dia_chi').value = customer.Dia_chi || '';
            document.getElementById('cccd').value = customer.Cccd || '';
          }
        });
      }
      
      // Get tour details from URL
      const urlParams = new URLSearchParams(window.location.search);
      const tourId = urlParams.get('tour') || urlParams.get('id'); // H·ªó tr·ª£ c·∫£ 'tour' v√† 'id'
      const scheduleId = urlParams.get('schedule');
      
      console.log('Detail tour page - Tour ID:', tourId);
      console.log('Detail tour page - Schedule ID:', scheduleId);
      console.log('Detail tour page - URL:', window.location.href);
      
      if (!tourId) {
        document.getElementById('booking-error').classList.remove('d-none');
        document.getElementById('error-message').textContent = 'Thi·∫øu th√¥ng tin tour';
        document.getElementById('booking-content').classList.add('d-none');
        return;
      }
      
      // Set tour ID in hidden input
      document.getElementById('ma_tour').value = tourId;
      
      if (scheduleId) {
        // N·∫øu ƒë√£ c√≥ schedule ID, ti·∫øp t·ª•c nh∆∞ b√¨nh th∆∞·ªùng
        document.getElementById('ma_lich_khoi_hanh').value = scheduleId;
        fetchTourDetails(tourId, scheduleId);
      } else {
        // N·∫øu ch∆∞a c√≥ schedule ID, t√¨m l·ªãch kh·ªüi h√†nh c√≥ s·∫µn
        findAvailableSchedule(tourId);
      }
      
      // Add event listeners
      document.querySelectorAll('.booking-count').forEach(input => {
        input.addEventListener('change', updateBookingSummary);
      });
      
      document.getElementById('check-promo').addEventListener('click', checkPromoCode);
      
      document.getElementById('booking-form').addEventListener('submit', function(e) {
        e.preventDefault();
        submitBooking();
      });
    });
    
    // T√¨m l·ªãch kh·ªüi h√†nh c√≥ s·∫µn
    function findAvailableSchedule(tourId) {
      // Hi·ªÉn th·ªã th√¥ng b√°o ƒëang t·∫£i
      document.getElementById('schedule-details').innerHTML = `
        <div class="text-center py-3">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">ƒêang t√¨m l·ªãch kh·ªüi h√†nh...</span>
          </div>
          <p class="mt-2">ƒêang t√¨m l·ªãch kh·ªüi h√†nh c√≥ s·∫µn...</p>
        </div>
      `;
      
      // Kh√¥ng c·∫ßn hardcode cho tour T001 n·ªØa, g·ªçi API ƒë·ªÉ l·∫•y t·∫•t c·∫£ l·ªãch tr√¨nh
      apiRequest(`/tours/${tourId}/upcoming-schedules`)
        .then(data => {
          if (!data || data.status !== 'success' || !data.data) {
            throw new Error('Kh√¥ng th·ªÉ t·∫£i l·ªãch kh·ªüi h√†nh');
          }
          
          const schedules = data.data.schedules;
          
          // N·∫øu kh√¥ng c√≥ l·ªãch n√†o
          if (!schedules || schedules.length === 0) {
            document.getElementById('booking-error').classList.remove('d-none');
            const errorDiv = document.getElementById('booking-error');
            errorDiv.querySelector('.alert').classList.remove('alert-danger');
            errorDiv.querySelector('.alert').classList.add('alert-info');
            document.getElementById('error-message').innerHTML = '<i class="fas fa-info-circle me-2"></i>Ch∆∞a c√≥ l·ªãch kh·ªüi h√†nh';
            const errorParagraph = errorDiv.querySelector('.alert p');
            if (errorParagraph) {
              errorParagraph.textContent = 'Tour n√†y hi·ªán ch∆∞a c√≥ l·ªãch kh·ªüi h√†nh. Vui l√≤ng quay l·∫°i sau ho·∫∑c li√™n h·ªá v·ªõi ch√∫ng t√¥i ƒë·ªÉ ƒë∆∞·ª£c th√¥ng b√°o khi c√≥ l·ªãch m·ªõi.';
            }
            document.getElementById('booking-content').classList.add('d-none');
            return;
          }
          
          // T√¨m l·ªãch c√≥ ch·ªó c√≤n tr·ªëng ƒë·∫ßu ti√™n
          const availableSchedule = schedules.find(schedule => {
            const availableSeats = schedule.availableSeats !== undefined ? 
              schedule.availableSeats : 
              (schedule.So_cho_con_lai !== undefined ? 
                schedule.So_cho_con_lai : 
                ((schedule.So_cho || 0) - (schedule.bookedSeats || 0)));
            return availableSeats > 0;
          });
          
          // N·∫øu kh√¥ng t√¨m th·∫•y l·ªãch n√†o c√≥ ch·ªó tr·ªëng
          if (!availableSchedule) {
            document.getElementById('booking-error').classList.remove('d-none');
            const errorDiv = document.getElementById('booking-error');
            errorDiv.querySelector('.alert').classList.remove('alert-danger', 'alert-info');
            errorDiv.querySelector('.alert').classList.add('alert-warning');
            document.getElementById('error-message').innerHTML = '<i class="fas fa-calendar-times me-2"></i>T·∫•t c·∫£ l·ªãch kh·ªüi h√†nh ƒë√£ ƒë·∫ßy';
            const errorParagraph = errorDiv.querySelector('.alert p');
            if (errorParagraph) {
              errorParagraph.textContent = 'R·∫•t ti·∫øc, t·∫•t c·∫£ c√°c l·ªãch kh·ªüi h√†nh c·ªßa tour n√†y hi·ªán ƒë√£ h·∫øt ch·ªó. Vui l√≤ng quay l·∫°i sau ƒë·ªÉ xem c√°c l·ªãch m·ªõi ho·∫∑c li√™n h·ªá v·ªõi ch√∫ng t√¥i ƒë·ªÉ ƒë∆∞·ª£c th√¥ng b√°o khi c√≥ ch·ªó tr·ªëng.';
            }
            document.getElementById('booking-content').classList.add('d-none');
            return;
          }
          
          // L·∫•y m√£ l·ªãch v√† hi·ªÉn th·ªã th√¥ng tin tour
          const scheduleId = availableSchedule.Ma_lich || availableSchedule.ma_lich;
          document.getElementById('ma_lich_khoi_hanh').value = scheduleId;
          
          // T·∫£i th√¥ng tin tour v√† l·ªãch
          fetchTourDetails(tourId, scheduleId);
          
          // Hi·ªÉn th·ªã t·∫•t c·∫£ c√°c l·ªãch kh·ªüi h√†nh trong m·ªôt ph·∫ßn ri√™ng
          displayAllSchedules(schedules, scheduleId);
        })
        .catch(error => {
          console.error('L·ªói khi t√¨m l·ªãch kh·ªüi h√†nh:', error);
          document.getElementById('booking-error').classList.remove('d-none');
          const errorDiv = document.getElementById('booking-error');
          errorDiv.querySelector('.alert').classList.remove('alert-info');
          errorDiv.querySelector('.alert').classList.add('alert-warning');
          document.getElementById('error-message').innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>T·∫°m th·ªùi kh√¥ng th·ªÉ t·∫£i l·ªãch kh·ªüi h√†nh';
          const errorParagraph = errorDiv.querySelector('.alert p');
          if (errorParagraph) {
            errorParagraph.textContent = 'Xin l·ªói, ch√∫ng t√¥i ƒëang g·∫∑p s·ª± c·ªë k·ªπ thu·∫≠t. Vui l√≤ng l√†m m·ªõi trang ho·∫∑c th·ª≠ l·∫°i sau v√†i ph√∫t. N·∫øu v·∫•n ƒë·ªÅ v·∫´n ti·∫øp t·ª•c, xin vui l√≤ng li√™n h·ªá b·ªô ph·∫≠n h·ªó tr·ª£.';
          }
          document.getElementById('booking-content').classList.add('d-none');
        });
    }
    
    // Hi·ªÉn th·ªã t·∫•t c·∫£ c√°c l·ªãch kh·ªüi h√†nh c·ªßa tour
    function displayAllSchedules(schedules, selectedScheduleId) {
      // T·∫°o ph·∫ßn hi·ªÉn th·ªã danh s√°ch l·ªãch kh·ªüi h√†nh n·∫øu ch∆∞a c√≥
      if (!document.getElementById('all-schedules')) {
        const scheduleCard = document.createElement('div');
        scheduleCard.className = 'card shadow-sm mb-4';
        scheduleCard.innerHTML = `
          <div class="card-header bg-primary text-white">
            <h4 class="m-0"><i class="fas fa-list-alt me-2"></i>T·∫•t c·∫£ l·ªãch kh·ªüi h√†nh</h4>
          </div>
          <div class="card-body p-4">
            <div id="all-schedules">
              <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">ƒêang t·∫£i...</span>
                </div>
              </div>
            </div>
          </div>
        `;
        
        // Th√™m v√†o sau ph·∫ßn schedule-details
        const scheduleDetails = document.getElementById('schedule-details').closest('.card');
        scheduleDetails.parentNode.insertBefore(scheduleCard, scheduleDetails.nextSibling);
      }
      
      // Hi·ªÉn th·ªã danh s√°ch l·ªãch
      const allSchedulesContainer = document.getElementById('all-schedules');
      if (schedules.length === 0) {
        allSchedulesContainer.innerHTML = '<p class="text-muted">Kh√¥ng c√≥ l·ªãch kh·ªüi h√†nh n√†o.</p>';
        return;
      }
      
      let html = '<table class="table table-hover"><thead><tr>' +
                 '<th>M√£ l·ªãch</th>' +
                 '<th>Ng√†y b·∫Øt ƒë·∫ßu</th>' +
                 '<th>Ng√†y k·∫øt th√∫c</th>' +
                 '<th>S·ªë ch·ªó c√≤n l·∫°i</th>' +
                 '<th>Thao t√°c</th>' +
                 '</tr></thead><tbody>';
      
      schedules.forEach(schedule => {
        const maLich = schedule.Ma_lich || schedule.ma_lich;
        const ngayBatDau = new Date(schedule.Ngay_bat_dau || schedule.ngay_bat_dau);
        const ngayKetThuc = new Date(schedule.Ngay_ket_thuc || schedule.ngay_ket_thuc);
        const soCho = schedule.So_cho || schedule.so_cho || 0;
        const bookedSeats = schedule.bookedSeats || 0;
        const availableSeats = schedule.availableSeats !== undefined ? 
          schedule.availableSeats : 
          (schedule.So_cho_con_lai !== undefined ? 
            schedule.So_cho_con_lai : 
            (soCho - bookedSeats));
        const isSelected = maLich === selectedScheduleId;
        const isAvailable = availableSeats > 0;
        const statusClass = !isAvailable ? 'table-secondary' : (isSelected ? 'table-primary' : '');
        
        html += `
          <tr class="${statusClass}">
            <td>${maLich}</td>
            <td>${formatDate(ngayBatDau)}</td>
            <td>${formatDate(ngayKetThuc)}</td>
            <td>
              <span class="${!isAvailable ? 'text-danger fw-bold' : ''}">
                ${availableSeats}/${soCho}
              </span>
              ${!isAvailable ? '<span class="badge bg-danger ms-2">H·∫øt ch·ªó</span>' : ''}
            </td>
            <td>
              ${isSelected ? 
                '<span class="badge bg-primary">ƒê√£ ch·ªçn</span>' : 
                (!isAvailable ? 
                  '<span class="badge bg-secondary">H·∫øt ch·ªó</span>' :
                  `<button class="btn btn-sm btn-outline-primary" onclick="selectAnotherSchedule('${maLich}')">Ch·ªçn</button>`
                )
              }
            </td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
      allSchedulesContainer.innerHTML = html;
    }
    
    // H√†m ƒë·ªÉ ch·ªçn l·ªãch kh·ªüi h√†nh kh√°c
    function selectAnotherSchedule(scheduleId) {
      document.getElementById('ma_lich_khoi_hanh').value = scheduleId;
      
      // T·∫£i th√¥ng tin l·ªãch
      fetchScheduleDetails(scheduleId);
      
      // C·∫≠p nh·∫≠t UI ƒë·ªÉ hi·ªÉn th·ªã l·ªãch ƒë√£ ch·ªçn
      const rows = document.querySelectorAll('#all-schedules tbody tr');
      rows.forEach(row => {
        if (row.cells[0].textContent === scheduleId) {
          row.classList.add('table-primary');
          row.cells[4].innerHTML = '<span class="badge bg-primary">ƒê√£ ch·ªçn</span>';
        } else {
          row.classList.remove('table-primary');
          const originalScheduleId = row.cells[0].textContent;
          row.cells[4].innerHTML = `<button class="btn btn-sm btn-outline-primary" onclick="selectAnotherSchedule('${originalScheduleId}')">Ch·ªçn</button>`;
        }
      });
    }
    
    // Function to fetch tour details
    function fetchTourDetails(tourId, scheduleId) {
      // Fetch tour data - kh√¥ng c·∫ßn hardcode n·ªØa
      apiRequest(`/tours/${tourId}`)
        .then(data => {
          if (data.status === 'success') {
            displayTourDetails(data.data.tour);
            fetchTourDestinations(tourId);
            fetchScheduleDetails(scheduleId);
          } else {
            throw new Error(data.message || 'Kh√¥ng th·ªÉ l·∫•y th√¥ng tin tour');
          }
        })
        .catch(error => {
          showErrorMessage('L·ªói khi l·∫•y th√¥ng tin tour: ' + error.message);
        });
    }
    
    // Function to fetch schedule details
    function fetchScheduleDetails(scheduleId) {
      // G·ªçi API ƒë·ªÉ l·∫•y th√¥ng tin l·ªãch, kh√¥ng c·∫ßn hardcode n·ªØa
      apiRequest(`/tours/schedules/${scheduleId}`)
        .then(data => {
          if (data.status === 'success') {
            // Debug: log d·ªØ li·ªáu schedule ƒë·ªÉ ki·ªÉm tra
            console.log('üìÖ Schedule data from API:', data.data.schedule);
            console.log('‚≠ê Guide rating info:', {
              guide_avg_rating: data.data.schedule?.guide_avg_rating,
              guide_rating_count: data.data.schedule?.guide_rating_count,
              Ma_huong_dan_vien: data.data.schedule?.Ma_huong_dan_vien
            });
            displayScheduleDetails(data.data.schedule);
          } else {
            throw new Error(data.message || 'Kh√¥ng th·ªÉ l·∫•y th√¥ng tin l·ªãch tr√¨nh');
          }
        })
        .catch(error => {
          showErrorMessage('L·ªói khi l·∫•y th√¥ng tin l·ªãch tr√¨nh: ' + error.message);
        });
    }
    
    // Function to display schedule details
    function displayScheduleDetails(schedule) {
      const startDate = new Date(schedule.Ngay_bat_dau);
      const endDate = new Date(schedule.Ngay_ket_thuc);
      
      // C·∫≠p nh·∫≠t ng√†y kh·ªüi h√†nh trong detail box
      const departureDate = document.getElementById('departure-date');
      if (departureDate) {
        departureDate.textContent = formatDate(startDate);
      }
      
      // C·∫≠p nh·∫≠t th·ªùi gian & ƒë·ªãa ƒëi·ªÉm
      const timeLocation = document.getElementById('time-location');
      if (timeLocation) {
        timeLocation.textContent = `${formatDate(startDate)} - ${formatDate(endDate)}`;
      }
      
      // L∆∞u th√¥ng tin HDV ƒë·ªÉ hi·ªÉn th·ªã trong modal
      window.currentScheduleGuide = schedule;
      
      // Hi·ªÉn th·ªã button ƒë·ªÉ xem th√¥ng tin HDV n·∫øu c√≥
      let guideButtonHtml = '';
      if (schedule.Ma_huong_dan_vien && schedule.Ten_huong_dan_vien) {
        guideButtonHtml = `
          <div class="mt-3">
            <button type="button" class="btn btn-outline-primary" onclick="showGuideModal()">
              <i class="fas fa-user-tie me-2"></i>Xem th√¥ng tin H∆∞·ªõng d·∫´n vi√™n
            </button>
          </div>
        `;
      } else {
        guideButtonHtml = `
          <div class="mt-3">
            <p class="text-muted mb-0"><i class="fas fa-info-circle me-2"></i>Ch∆∞a c√≥ h∆∞·ªõng d·∫´n vi√™n ƒë∆∞·ª£c ph√¢n c√¥ng</p>
          </div>
        `;
      }
      
      document.getElementById('schedule-details').innerHTML = `
        <h5 class="fw-bold mb-3">L·ªãch tr√¨nh chi ti·∫øt</h5>
        <p><i class="fas fa-calendar-day me-2"></i> Ng√†y b·∫Øt ƒë·∫ßu: ${formatDate(startDate)}</p>
        <p><i class="fas fa-calendar-check me-2"></i> Ng√†y k·∫øt th√∫c: ${formatDate(endDate)}</p>
        <p><i class="fas fa-users me-2"></i> S·ªë ch·ªó c√≤n l·∫°i: <span class="badge bg-success">${schedule.availableSeats !== undefined ? schedule.availableSeats : (schedule.So_cho_con_lai || schedule.So_cho || 0)}</span></p>
        ${guideButtonHtml}
      `;
      
      // Set available seats in hidden input for validation
      const availableSeats = schedule.availableSeats !== undefined ? schedule.availableSeats : (schedule.So_cho_con_lai || schedule.So_cho || 0);
      document.getElementById('so_nguoi_lon').setAttribute('max', availableSeats);
      document.getElementById('so_tre_em').setAttribute('max', availableSeats);
      
      // L·∫•y m√¥ t·∫£ t·ª´ tour
      if (schedule.Ma_tour) {
        fetchTourDescription(schedule.Ma_tour);
        // Load ratings for tour
        loadTourRatings(schedule.Ma_tour);
        
        // C·∫≠p nh·∫≠t summary itinerary n·∫øu ch∆∞a c√≥
        apiRequest(`/tours/${schedule.Ma_tour}`)
          .then(data => {
            if (data.status === 'success' && data.data.tour && data.data.tour.Mo_ta) {
              displaySummaryItinerary(data.data.tour.Mo_ta);
            }
          })
          .catch(err => console.error('L·ªói khi l·∫•y m√¥ t·∫£ tour:', err));
      }
    }
    
    // Function to fetch tour description
    function fetchTourDescription(tourId) {
      console.log('ƒêang l·∫•y m√¥ t·∫£ cho tour:', tourId);
      
      // Truy v·∫•n tr·ª±c ti·∫øp v√†o b·∫£ng Tour_du_lich ƒë·ªÉ l·∫•y m√¥ t·∫£ ƒë√∫ng
      console.log('G·ªçi API direct endpoint:', `${CONFIG.API_BASE_URL}/tours/direct/${tourId}`);
      fetch(`${CONFIG.API_BASE_URL}/tours/direct/${tourId}`, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      })
      .then(response => {
        console.log('K·∫øt qu·∫£ t·ª´ API direct endpoint:', response.status, response.statusText);
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        console.log('D·ªØ li·ªáu tour tr·ª±c ti·∫øp t·ª´ b·∫£ng Tour_du_lich:', data);
        if (data.status === 'success' && data.data.tour) {
          const tour = data.data.tour;
          console.log('M√¥ t·∫£ tour t·ª´ b·∫£ng Tour_du_lich:', tour.Mo_ta);
          
          const scheduleDetails = document.getElementById('schedule-details');
          if (!scheduleDetails.querySelector('.bg-light')) {
            scheduleDetails.innerHTML += `
              <div class="mt-3 p-3 bg-light rounded">
                <h6 class="fw-bold"><i class="fas fa-info-circle me-2"></i>M√¥ t·∫£ tour:</h6>
                <p>${tour.Mo_ta || 'Ch∆∞a c√≥ m√¥ t·∫£'}</p>
           
              </div>
            `;
          }
        }
      })
      .catch(error => {
        console.error('L·ªói khi l·∫•y m√¥ t·∫£ tour t·ª´ b·∫£ng Tour_du_lich:', error);
        
        // Fallback: S·ª≠ d·ª•ng API th√¥ng th∆∞·ªùng n·∫øu API tr·ª±c ti·∫øp kh√¥ng ho·∫°t ƒë·ªông
        console.log('Chuy·ªÉn sang s·ª≠ d·ª•ng API th√¥ng th∆∞·ªùng');
        apiRequest(`/tours/${tourId}`)
          .then(data => {
            console.log('D·ªØ li·ªáu tour t·ª´ API th√¥ng th∆∞·ªùng:', data);
            if (data.status === 'success' && data.data.tour) {
              const tour = data.data.tour;
              
              const scheduleDetails = document.getElementById('schedule-details');
              if (!scheduleDetails.querySelector('.bg-light')) {
                scheduleDetails.innerHTML += `
                  <div class="mt-3 p-3 bg-light rounded">
                    <h6 class="fw-bold"><i class="fas fa-info-circle me-2"></i>M√¥ t·∫£ tour:</h6>
                    <p>${tour.Mo_ta || 'Ch∆∞a c√≥ m√¥ t·∫£'}</p>
                    <p class="text-warning small"><i class="fas fa-exclamation-triangle me-1"></i> L∆∞u √Ω: ƒê√¢y l√† m√¥ t·∫£ t·ª´ API th√¥ng th∆∞·ªùng, c√≥ th·ªÉ kh√¥ng ph·∫£i t·ª´ b·∫£ng Tour_du_lich.</p>
                  </div>
                `;
              }
            }
          })
          .catch(err => {
            console.error('L·ªói khi l·∫•y m√¥ t·∫£ tour t·ª´ API th√¥ng th∆∞·ªùng:', err);
            
            const scheduleDetails = document.getElementById('schedule-details');
            if (!scheduleDetails.querySelector('.bg-light')) {
              scheduleDetails.innerHTML += `
                <div class="mt-3 p-3 bg-light rounded">
                  <h6 class="fw-bold"><i class="fas fa-info-circle me-2"></i>M√¥ t·∫£ tour:</h6>
                  <p class="text-danger">Kh√¥ng th·ªÉ l·∫•y th√¥ng tin m√¥ t·∫£ tour. Vui l√≤ng th·ª≠ l·∫°i sau.</p>
                </div>
              `;
            }
          });
      });
    }
    
    // Function to display tour details
    function displayTourDetails(tour) {
      // C·∫≠p nh·∫≠t banner v·ªõi ·∫£nh n·ªÅn
      const bannerElement = document.getElementById('tour-banner');
      
      // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ v√† gi√° ·ªü ph·∫ßn n·ªôi dung
      const tourTitle = document.getElementById('tour-title');
      const tourPriceDisplay = document.getElementById('tour-price-display');
      const tourPriceValue = document.getElementById('tour-price-value');
      
      if (tourTitle) {
        tourTitle.textContent = tour.Ten_tour;
      }
      
      if (tourPriceValue) {
        tourPriceValue.textContent = formatCurrency(tour.Gia_nguoi_lon).replace(' VNƒê', '');
        tourPriceDisplay.classList.remove('d-none');
      }
      
      // ƒê·∫∑t ·∫£nh n·ªÅn n·∫øu c√≥
      if (tour.Hinh_anh) {
        console.log('·∫¢nh tour g·ªëc:', tour.Hinh_anh);
        let imageUrl;
        
        // X·ª≠ l√Ω ƒë∆∞·ªùng d·∫´n ·∫£nh
        if (tour.Hinh_anh.startsWith('http')) {
          // N·∫øu l√† URL ƒë·∫ßy ƒë·ªß
          imageUrl = tour.Hinh_anh;
        } else {
          // Tr∆∞·ªùng h·ª£p ƒë∆∞·ªùng d·∫´n t∆∞∆°ng ƒë·ªëi
          // L·∫•y base URL kh√¥ng bao g·ªìm /api
          const baseUrl = window.API_URL.replace('/api', '');
          
          // ƒê·∫£m b·∫£o ƒë∆∞·ªùng d·∫´n ·∫£nh b·∫Øt ƒë·∫ßu b·∫±ng /
          const imagePath = tour.Hinh_anh.startsWith('/') ? tour.Hinh_anh : '/' + tour.Hinh_anh;
          
          // N·∫øu ƒë∆∞·ªùng d·∫´n ch∆∞a bao g·ªìm /images th√¨ th√™m v√†o
          if (!imagePath.includes('/images/')) {
            imageUrl = `${baseUrl}/images${imagePath}`;
          } else {
            imageUrl = `${baseUrl}${imagePath}`;
          }
        }
        
        console.log('ƒê∆∞·ªùng d·∫´n ·∫£nh ƒë√£ x·ª≠ l√Ω:', imageUrl);
        bannerElement.style.backgroundImage = `url('${imageUrl}')`;
      }
      
      // C·∫≠p nh·∫≠t th√¥ng tin chi ti·∫øt tour
      updateTourDetailBoxes(tour);
      
      // Hi·ªÉn th·ªã m√¥ t·∫£ tour v√†o summary itinerary
      displaySummaryItinerary(tour.Mo_ta);
      
      // Load and display promotions
      loadTourPromotions(tour.Ma_tour, tour);
      
      // Load related tours
      loadRelatedTours(tour.Ma_tour);
    }
    
    // Function to display summary itinerary from tour description
    function displaySummaryItinerary(moTa) {
      const summaryItinerary = document.getElementById('summary-itinerary');
      if (!summaryItinerary) return;
      
      if (!moTa || moTa.trim() === '') {
        summaryItinerary.innerHTML = '<p class="text-muted text-center">Ch∆∞a c√≥ l·ªãch tr√¨nh t√≥m t·∫Øt</p>';
        return;
      }
      
      // Parse m√¥ t·∫£ tour ƒë·ªÉ t√°ch th√†nh c√°c ng√†y
      // H·ªó tr·ª£ c√°c format: "Ng√†y 1:", "Day 1:", "Ng√†y 1 -", v.v.
      const dayPattern = /(?:Ng√†y|Day|Ng√†y)\s*(\d+)[:\-\.]?\s*(.+?)(?=(?:Ng√†y|Day|Ng√†y)\s*\d+|$)/gi;
      const matches = [];
      let match;
      
      // T√¨m t·∫•t c·∫£ c√°c ng√†y trong m√¥ t·∫£
      while ((match = dayPattern.exec(moTa)) !== null) {
        matches.push({
          day: match[1],
          content: match[2].trim()
        });
      }
      
      // N·∫øu kh√¥ng t√¨m th·∫•y format ng√†y, th·ª≠ t√°ch theo d√≤ng ho·∫∑c d·∫•u xu·ªëng d√≤ng
      if (matches.length === 0) {
        // T√°ch theo d√≤ng n·∫øu c√≥
        const lines = moTa.split(/\n|\r\n/).filter(line => line.trim().length > 0);
        if (lines.length > 0) {
          lines.forEach((line, index) => {
            // Ki·ªÉm tra xem d√≤ng c√≥ ch·ª©a "Ng√†y" kh√¥ng
            const dayMatch = line.match(/(?:Ng√†y|Day)\s*(\d+)/i);
            if (dayMatch) {
              matches.push({
                day: dayMatch[1],
                content: line.replace(/(?:Ng√†y|Day)\s*\d+[:\-\.]?\s*/i, '').trim()
              });
            } else if (line.trim().length > 10) {
              // N·∫øu d√≤ng ƒë·ªß d√†i, coi nh∆∞ m·ªôt m·ª•c l·ªãch tr√¨nh
              matches.push({
                day: index + 1,
                content: line.trim()
              });
            }
          });
        }
      }
      
      // N·∫øu v·∫´n kh√¥ng c√≥, hi·ªÉn th·ªã to√†n b·ªô m√¥ t·∫£
      if (matches.length === 0) {
        summaryItinerary.innerHTML = `
          <div class="itinerary-item">
            <div class="d-flex align-items-center">
              <i class="fas fa-info-circle me-3 itinerary-icon"></i>
              <span class="itinerary-text">${moTa}</span>
            </div>
          </div>
        `;
        return;
      }
      
      // Hi·ªÉn th·ªã c√°c ng√†y ƒë√£ parse
      let html = '';
      const iconSets = [
        ['fa-mountain', 'fa-water'],
        ['fa-sun', 'fa-hiking'],
        ['fa-utensils', 'fa-ship'],
        ['fa-camera', 'fa-map-marked-alt'],
        ['fa-bed', 'fa-plane']
      ];
      
      matches.forEach((item, index) => {
        const icons = iconSets[index % iconSets.length];
        html += `
          <div class="itinerary-item ${index < matches.length - 1 ? 'mb-3' : ''}">
            <div class="d-flex align-items-center">
              <i class="fas ${icons[0]} me-3 itinerary-icon"></i>
              <i class="fas ${icons[1]} me-3 itinerary-icon"></i>
              <span class="itinerary-text">Ng√†y ${item.day}: ${item.content}</span>
            </div>
          </div>
        `;
      });
      
      summaryItinerary.innerHTML = html;
    }
    
    // Function to update tour detail boxes
    function updateTourDetailBoxes(tour) {
      // C·∫≠p nh·∫≠t gi√° ƒë√£ bao g·ªìm
      const priceIncludes = document.getElementById('price-includes');
      if (priceIncludes) {
        priceIncludes.textContent = 'V·∫≠n chuy·ªÉn, ƒÉn u·ªëng, kh√°ch s·∫°n, h∆∞·ªõng d·∫´n vi√™n';
      }
      
      // Hi·ªÉn th·ªã checkmark cho c√°c box c√≥ th√¥ng tin
      const departureCheck = document.getElementById('departure-check');
      const priceCheck = document.getElementById('price-check');
      if (departureCheck) departureCheck.classList.remove('d-none');
      if (priceCheck) priceCheck.classList.remove('d-none');
    }

    // Function to load and display tour promotions
    async function loadTourPromotions(tourId, tour) {
      try {
        const response = await fetch(`${window.API_URL}/promotions/applicable/${tourId}`);
        const data = await response.json();
        
        if (data.success && data.data) {
          displayTourDetailsWithPromotions(tour, data.data);
        } else {
          displayTourDetailsWithPromotions(tour, null);
        }
      } catch (error) {
        console.error('Error loading promotions:', error);
        displayTourDetailsWithPromotions(tour, null);
      }
    }

    // Function to display tour details with promotions
    function displayTourDetailsWithPromotions(tour, promotions) {
      const adultPrice = parseFloat(tour.Gia_nguoi_lon);
      const childPrice = parseFloat(tour.Gia_tre_em);
      
      let adultDisplayPrice = adultPrice;
      let childDisplayPrice = childPrice;
      let discountInfo = '';
      
      // Check for applicable promotions
      if (promotions) {
        let maxDiscount = 0;
        let discountSource = '';
        
        // Check global discount
        if (promotions.global && promotions.global.Gia_tri > maxDiscount) {
          maxDiscount = promotions.global.Gia_tri;
          discountSource = 'to√†n site';
        }
        
        // Check tour-specific coupon
        if (promotions.coupon && promotions.coupon.Gia_tri > maxDiscount) {
          maxDiscount = promotions.coupon.Gia_tri;
          discountSource = 'coupon';
        }
        
        if (maxDiscount > 0) {
          adultDisplayPrice = adultPrice * (1 - maxDiscount / 100);
          childDisplayPrice = childPrice * (1 - maxDiscount / 100);
          
          discountInfo = `
            <div class="alert alert-success mt-3">
              <i class="fas fa-tags me-2"></i>
              <strong>üéâ ƒêang c√≥ khuy·∫øn m√£i!</strong><br>
              Gi·∫£m ${maxDiscount}% ${discountSource === 'to√†n site' ? 'cho t·∫•t c·∫£ tour' : `v·ªõi m√£ ${promotions.coupon.Ma_km}`}
              ${promotions.coupon && promotions.coupon.Ngay_ket_thuc ? 
                `<br><small>H·∫øt h·∫°n: ${formatDate(new Date(promotions.coupon.Ngay_ket_thuc))}</small>` : ''}
            </div>
          `;
        }
      }
      
      document.getElementById('tour-details').innerHTML = `
        <h3 class="fw-bold mb-3">${tour.Ten_tour}</h3>
        <p><i class="fas fa-clock me-2"></i> Th·ªùi gian: ${tour.Thoi_gian} ng√†y</p>
        <p><i class="fas fa-tag me-2"></i> Lo·∫°i tour: ${tour.Loai_tour === 'trong_nuoc' ? 'Trong n∆∞·ªõc' : 'Qu·ªëc t·∫ø'}</p>
        
        ${discountInfo}
        
        <div class="d-flex justify-content-between mb-2 mt-3">
          <h5>Gi√° ng∆∞·ªùi l·ªõn:</h5>
          <div class="text-end">
            ${adultDisplayPrice < adultPrice ? `
              <div class="text-decoration-line-through text-muted small">${formatCurrency(adultPrice)}</div>
              <h5 class="text-danger fw-bold mb-0" id="adult-price" data-price="${adultPrice}" data-discounted-price="${adultDisplayPrice}">
                ${formatCurrency(adultDisplayPrice)}
              </h5>
            ` : `
              <h5 class="text-danger fw-bold" id="adult-price" data-price="${adultPrice}" data-discounted-price="${adultDisplayPrice}">
                ${formatCurrency(adultDisplayPrice)}
              </h5>
            `}
          </div>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <h5>Gi√° tr·∫ª em:</h5>
          <div class="text-end">
            ${childDisplayPrice < childPrice ? `
              <div class="text-decoration-line-through text-muted small">${formatCurrency(childPrice)}</div>
              <h5 class="text-danger fw-bold mb-0" id="child-price" data-price="${childPrice}" data-discounted-price="${childDisplayPrice}">
                ${formatCurrency(childDisplayPrice)}
              </h5>
            ` : `
              <h5 class="text-danger fw-bold" id="child-price" data-price="${childPrice}" data-discounted-price="${childDisplayPrice}">
                ${formatCurrency(childDisplayPrice)}
              </h5>
            `}
          </div>
        </div>
      `;
      
      // Update booking summary
      updateBookingSummary();
    }
    
    // Function to fetch tour destinations
    function fetchTourDestinations(tourId) {
      apiRequest(`/tours/${tourId}/destinations`)
        .then(data => {
          if (data.status === 'success') {
            displayDestinations(data.data.destinations);
          } else {
            throw new Error(data.message || 'Kh√¥ng th·ªÉ l·∫•y th√¥ng tin ƒëi·ªÉm ƒë·∫øn');
          }
        })
        .catch(error => {
          document.getElementById('destinations-list').innerHTML = '<p class="text-muted">Kh√¥ng c√≥ th√¥ng tin ƒëi·ªÉm ƒë·∫øn.</p>';
        });
    }
    
    // Function to display destinations
    function displayDestinations(destinations) {
      if (!destinations || destinations.length === 0) {
        document.getElementById('destinations-list').innerHTML = '<p class="text-muted">Kh√¥ng c√≥ th√¥ng tin ƒëi·ªÉm ƒë·∫øn.</p>';
        return;
      }
      
      let html = '<div class="row">';
      
      destinations.forEach(dest => {
        html += `
          <div class="col-md-6 mb-3">
            <div class="card h-100">
              ${dest.Hinh_anh ? `<img src="${dest.Hinh_anh}" class="card-img-top" alt="${dest.Ten_dia_danh}" style="object-fit: cover; height: 200px;">` : ''}
              <div class="card-body">
                <h5 class="card-title">${dest.Ten_dia_danh}</h5>
                <p class="card-text small">${dest.Mo_ta ? dest.Mo_ta.substring(0, 100) : 'Ch∆∞a c√≥ m√¥ t·∫£'}...</p>
              </div>
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      document.getElementById('destinations-list').innerHTML = html;
    }
    
    // Function to update booking summary
    function updateBookingSummary() {
      const adultCount = parseInt(document.getElementById('so_nguoi_lon').value) || 0;
      const childCount = parseInt(document.getElementById('so_tre_em').value) || 0;
      
      const adultPriceEl = document.getElementById('adult-price');
      const childPriceEl = document.getElementById('child-price');
      
      if (!adultPriceEl) return;
      
      // Use discounted prices if available, otherwise use original prices
      const adultPrice = parseFloat(adultPriceEl.dataset.discountedPrice || adultPriceEl.dataset.price) || 0;
      const childPrice = parseFloat(childPriceEl.dataset.discountedPrice || childPriceEl.dataset.price) || 0;
      
      const totalAdultPrice = adultPrice * adultCount;
      const totalChildPrice = childPrice * childCount;
      const totalPrice = totalAdultPrice + totalChildPrice;
      
      document.getElementById('adult-summary').textContent = `${adultCount} x ${formatCurrency(adultPrice)} = ${formatCurrency(totalAdultPrice)}`;
      document.getElementById('child-summary').textContent = `${childCount} x ${formatCurrency(childPrice)} = ${formatCurrency(totalChildPrice)}`;
      document.getElementById('total-price').textContent = formatCurrency(totalPrice);
    }
    
    // Function to check promo code
    function checkPromoCode() {
      const promoCode = document.getElementById('ma_khuyen_mai').value.trim();
      
      if (!promoCode) {
        document.getElementById('promo-result').innerHTML = '<span class="text-danger">Vui l√≤ng nh·∫≠p m√£ khuy·∫øn m√£i</span>';
        return;
      }
      
      document.getElementById('promo-result').innerHTML = '<span class="text-info">ƒêang ki·ªÉm tra...</span>';
      
      fetch(`${window.API_URL}/promotions/validate/${promoCode}`)
        .then(response => response.json())
        .then(data => {
          if (data.success && data.data) {
            const promotion = data.data;
            document.getElementById('promo-result').innerHTML = `
              <span class="text-success">
                <i class="fas fa-check-circle me-1"></i>
                √Åp d·ª•ng gi·∫£m ${promotion.Gia_tri}% 
                ${promotion.Ngay_ket_thuc ? `(ƒë·∫øn ${formatDate(new Date(promotion.Ngay_ket_thuc))})` : ''}
                <br><small class="text-muted">${promotion.loai_ap_dung}</small>
              </span>
            `;
            
            // Apply additional discount to total price
            applyAdditionalDiscount(promotion.Gia_tri);
          } else {
            document.getElementById('promo-result').innerHTML = '<span class="text-danger">M√£ khuy·∫øn m√£i kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n</span>';
          }
        })
        .catch(error => {
          console.error('Error validating promo code:', error);
          document.getElementById('promo-result').innerHTML = '<span class="text-danger">L·ªói khi ki·ªÉm tra m√£ khuy·∫øn m√£i</span>';
        });
    }
    
    // Function to apply additional discount (for manual coupon codes)
    function applyAdditionalDiscount(discountPercent) {
      const adultCount = parseInt(document.getElementById('so_nguoi_lon').value) || 0;
      const childCount = parseInt(document.getElementById('so_tre_em').value) || 0;
      
      const adultPriceEl = document.getElementById('adult-price');
      const childPriceEl = document.getElementById('child-price');
      
      if (!adultPriceEl) return;
      
      // Use current discounted prices (already applied from automatic promotions)
      const adultPrice = parseFloat(adultPriceEl.dataset.discountedPrice || adultPriceEl.dataset.price) || 0;
      const childPrice = parseFloat(childPriceEl.dataset.discountedPrice || childPriceEl.dataset.price) || 0;
      
      const totalAdultPrice = adultPrice * adultCount;
      const totalChildPrice = childPrice * childCount;
      const subtotal = totalAdultPrice + totalChildPrice;
      
      const discountAmount = subtotal * (discountPercent / 100);
      const finalPrice = subtotal - discountAmount;
      
      document.getElementById('total-price').innerHTML = `
        <div class="text-decoration-line-through text-muted">${formatCurrency(subtotal)}</div>
        <div class="text-success fw-bold">${formatCurrency(finalPrice)}</div>
        <small class="text-success">Ti·∫øt ki·ªám: ${formatCurrency(discountAmount)}</small>
      `;
    }
    
    // Function to format date
    function formatDate(date) {
      return date.toLocaleDateString('vi-VN', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      });
    }
    
    // Function to format currency
    function formatCurrency(amount) {
      return new Intl.NumberFormat('vi-VN', {
        style: 'currency',
        currency: 'VND'
      }).format(amount);
    }
    
    // Function to submit booking
    async function submitBooking() {
      // Ki·ªÉm tra ƒëƒÉng nh·∫≠p
      if (!isLoggedIn()) {
        Swal.fire({
          title: 'C·∫ßn ƒëƒÉng nh·∫≠p',
          text: 'Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒë·∫∑t tour',
          icon: 'info',
          showCancelButton: true,
          confirmButtonText: 'ƒêƒÉng nh·∫≠p',
          cancelButtonText: 'H·ªßy'
        }).then((result) => {
          if (result.isConfirmed) {
            window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.href);
          }
        });
        return;
      }
      
      // ƒê·∫£m b·∫£o c√≥ th√¥ng tin kh√°ch h√†ng
      console.log('üß© ƒêang ki·ªÉm tra th√¥ng tin kh√°ch h√†ng tr∆∞·ªõc khi ƒë·∫∑t tour...');
      let customerInfo = null;
      
      try {
        // G·ªçi API /customers/me tr∆∞·ªõc ƒë·ªÉ l·∫•y th√¥ng tin kh√°ch h√†ng
        const response = await fetch(`${window.API_URL}/customers/me`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });
        
        const data = await response.json();
        console.log('üß© K·∫øt qu·∫£ API customers/me:', data);
        
        if (response.ok && data.status === 'success' && data.data.customer) {
          customerInfo = data.data.customer;
          console.log('‚úÖ ƒê√£ t√¨m th·∫•y th√¥ng tin kh√°ch h√†ng:', customerInfo);
        } else {
          console.error('‚ùå Kh√¥ng t√¨m th·∫•y th√¥ng tin kh√°ch h√†ng:', data);
          Swal.fire({
            title: 'C·∫ßn c·∫≠p nh·∫≠t th√¥ng tin',
            text: 'Vui l√≤ng c·∫≠p nh·∫≠t th√¥ng tin c√° nh√¢n tr∆∞·ªõc khi ƒë·∫∑t tour',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'C·∫≠p nh·∫≠t ngay',
            cancelButtonText: 'H·ªßy'
          }).then((result) => {
            if (result.isConfirmed) {
              window.location.href = 'profile.html';
            }
          });
          return;
        }
      } catch (error) {
        console.error('‚ùå L·ªói khi ki·ªÉm tra th√¥ng tin kh√°ch h√†ng:', error);
        Swal.fire({
          title: 'L·ªói',
          text: 'Kh√¥ng th·ªÉ ki·ªÉm tra th√¥ng tin kh√°ch h√†ng. Vui l√≤ng th·ª≠ l·∫°i sau.',
          icon: 'error'
        });
        return;
      }
      
      // L·∫•y d·ªØ li·ªáu t·ª´ form
      const form = document.getElementById('booking-form');
      
      // Ki·ªÉm tra valid form
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }
      
      // Disable submit button v√† hi·ªÉn th·ªã loading
      const submitBtn = document.getElementById('submit-booking-btn');
      const originalText = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> ƒêang x·ª≠ l√Ω...';
      
      // L·∫•y d·ªØ li·ªáu t·ª´ form
      const formData = new FormData(form);
      
      // Debug th√¥ng tin form
      console.log('---- FORM DATA DEBUG ----');
      for (const pair of formData.entries()) {
        console.log(`${pair[0]}: ${pair[1]}`);
      }
      
      // T·∫°o object d·ªØ li·ªáu g·ª≠i ƒëi
      const bookingData = {
        ma_tour: formData.get('ma_tour'),
        ma_lich_khoi_hanh: formData.get('ma_lich_khoi_hanh'),
        so_nguoi_lon: parseInt(formData.get('so_nguoi_lon')),
        so_tre_em: parseInt(formData.get('so_tre_em')) || 0,
        ma_khuyen_mai: formData.get('ma_khuyen_mai') || null,
        ma_khach_hang: customerInfo.Ma_khach_hang, // Th√™m m√£ kh√°ch h√†ng
        dich_vu: getSelectedServices().map(service => ({
          ma_dich_vu: service.ma_dich_vu,
          so_luong: service.so_luong
        }))
      };

      // Ki·ªÉm tra d·ªØ li·ªáu tr∆∞·ªõc khi g·ª≠i
      if (!bookingData.ma_tour || !bookingData.ma_lich_khoi_hanh || !bookingData.so_nguoi_lon) {
        console.error('Validation th·∫•t b·∫°i:', {
          ma_tour: bookingData.ma_tour, 
          ma_lich_khoi_hanh: bookingData.ma_lich_khoi_hanh, 
          so_nguoi_lon: bookingData.so_nguoi_lon
        });
        Swal.fire('L·ªói', 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc', 'error');
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
        return;
      }
      
      // Ki·ªÉm tra m√£ kh√°ch h√†ng
      if (!bookingData.ma_khach_hang) {
        console.error('‚ùå Thi·∫øu m√£ kh√°ch h√†ng khi ƒë·∫∑t tour!');
        Swal.fire({
          title: 'L·ªói',
          text: 'Kh√¥ng th·ªÉ x√°c ƒë·ªãnh m√£ kh√°ch h√†ng. Vui l√≤ng c·∫≠p nh·∫≠t th√¥ng tin c√° nh√¢n.',
          icon: 'error',
          showCancelButton: true,
          confirmButtonText: 'C·∫≠p nh·∫≠t ngay',
          cancelButtonText: 'H·ªßy'
        }).then((result) => {
          if (result.isConfirmed) {
            window.location.href = 'profile.html';
          }
        });
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
        return;
      }

      console.log('üì® D·ªØ li·ªáu ƒë·∫∑t tour:', JSON.stringify(bookingData, null, 2));
      console.log('üîë Token:', localStorage.getItem('token'));

      // G·ªçi API ƒë·ªÉ ƒë·∫∑t tour
      fetch(`${window.API_URL}/bookings`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        body: JSON.stringify(bookingData)
      })
      .then(async response => {
        const responseText = await response.text();
        console.log('üì• Raw API response:', responseText);
        
        let data;
        try {
          data = JSON.parse(responseText);
        } catch (error) {
          throw new Error('Invalid JSON response from server: ' + responseText);
        }
        
        if (!response.ok) {
          throw new Error(data.message || 'C√≥ l·ªói x·∫£y ra khi ƒë·∫∑t tour');
        }
        return data;
      })
      .then(data => {
        if (data.status === 'success') {
          // Reload l·∫°i d·ªØ li·ªáu l·ªãch kh·ªüi h√†nh ƒë·ªÉ c·∫≠p nh·∫≠t s·ªë ch·ªó c√≤n l·∫°i
          console.log('üîÑ Reloading schedule data after booking...');
          const tourId = new URLSearchParams(window.location.search).get('tour') || new URLSearchParams(window.location.search).get('id');
          if (tourId) {
            findAvailableSchedule(tourId);
          }
          
          // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
          Swal.fire({
            title: 'ƒê·∫∑t tour th√†nh c√¥ng!',
            html: `
              <div class="text-start mb-3">
                <p><strong>M√£ ƒë·∫∑t tour:</strong> ${data.data.bookingId}</p>
                <p><strong>M√£ kh√°ch h√†ng:</strong> ${data.data.booking.Ma_khach_hang || data.data.booking.customer_info?.ma_khach_hang}</p>
                <p><strong>T√†i kho·∫£n ƒë·∫∑t:</strong> ${data.data.booking.Id_user || data.data.booking.customer_info?.id_user}</p>
                <p><strong>T·ªïng ti·ªÅn:</strong> ${formatCurrency(data.data.booking.Tong_tien)}</p>
                <p><strong>S·ªë ch·ªó c√≤n l·∫°i:</strong> ${data.data.available_seats || 'N/A'}</p>
              </div>
              <p>B·∫°n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn ƒë·∫øn trang thanh to√°n</p>
            `,
            icon: 'success',
            confirmButtonText: 'ƒê·∫øn trang thanh to√°n'
          }).then((result) => {
            if (result.isConfirmed) {
              window.location.href = `payment.html?booking=${data.data.bookingId}`;
            }
          });
        } else {
          throw new Error(data.message || 'C√≥ l·ªói x·∫£y ra khi ƒë·∫∑t tour');
        }
      })
      .catch(error => {
        console.error('‚ùå L·ªói khi ƒë·∫∑t tour:', error);
        Swal.fire('L·ªói', error.message, 'error');
      })
      .finally(() => {
        // Restore submit button state
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
      });
    }
    
    // Function to get selected services
    function getSelectedServices() {
      const services = [];
      document.querySelectorAll('.service-checkbox:checked').forEach(checkbox => {
        const serviceId = checkbox.value;
        const quantity = parseInt(document.getElementById(`qty-${serviceId}`).value) || 1;
        services.push({
          ma_dich_vu: serviceId,
          so_luong: quantity
        });
      });
      return services;
    }
    
    // Export c√°c h√†m c·∫ßn thi·∫øt cho global scope
    window.selectAnotherSchedule = selectAnotherSchedule;
    
    // Load ratings for tour
    async function loadTourRatings(tourId) {
      try {
        console.log('üîç Loading ratings for tour:', tourId);
        
        const response = await fetch(`${CONFIG.API_BASE_URL}/ratings/tour/${tourId}`);
        if (!response.ok) {
          throw new Error('Kh√¥ng th·ªÉ t·∫£i ƒë√°nh gi√°');
        }
        
        const data = await response.json();
        console.log('üìä Ratings data:', data);
        
        const ratingsContainer = document.getElementById('tour-ratings');
        if (!ratingsContainer) return;
        
        if (data.status === 'success' && data.data.ratings.length > 0) {
          const ratings = data.data.ratings;
          const averageRating = data.data.averageRating || 0;
          const totalRatings = ratings.length;
          
          let ratingsHTML = `
            <div class="mb-4">
              <div class="d-flex align-items-center mb-3">
                <div class="me-3">
                  <div class="display-6 text-warning">${parseFloat(averageRating).toFixed(1)}</div>
                  <div class="text-muted small">${totalRatings} ƒë√°nh gi√°</div>
                </div>
                <div class="flex-grow-1">
                  ${generateStarsHTML(averageRating)}
                </div>
              </div>
            </div>
            <div class="ratings-list">
          `;
          
          ratings.forEach(rating => {
            ratingsHTML += `
              <div class="rating-item border-bottom pb-3 mb-3">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <div>
                    <strong>${rating.Ten_khach_hang || 'Kh√°ch h√†ng'}</strong>
                    <div class="text-warning">${generateStarsHTML(rating.So_sao)}</div>
                  </div>
                  <small class="text-muted">${new Date(rating.Ngay_danh_gia).toLocaleDateString('vi-VN')}</small>
                </div>
                <p class="mb-0">${rating.Binh_luan || 'Kh√¥ng c√≥ b√¨nh lu·∫≠n'}</p>
              </div>
            `;
          });
          
          ratingsHTML += '</div>';
          ratingsContainer.innerHTML = ratingsHTML;
        } else {
          ratingsContainer.innerHTML = `
            <div class="text-center text-muted py-4">
              <i class="fas fa-star fa-2x mb-3"></i>
              <p>Ch∆∞a c√≥ ƒë√°nh gi√° n√†o cho tour n√†y</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('‚ùå L·ªói load ratings:', error);
        const ratingsContainer = document.getElementById('tour-ratings');
        if (ratingsContainer) {
          ratingsContainer.innerHTML = `
            <div class="text-center text-danger py-4">
              <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
              <p>Kh√¥ng th·ªÉ t·∫£i ƒë√°nh gi√°</p>
            </div>
          `;
        }
      }
    }
    
    // Generate stars HTML
    function generateStarsHTML(rating) {
      const fullStars = Math.floor(rating);
      const hasHalfStar = rating % 1 >= 0.5;
      const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
      
      let stars = '';
      
      // Sao ƒë·∫ßy
      for (let i = 0; i < fullStars; i++) {
        stars += '<i class="fas fa-star"></i>';
      }
      
      // Sao n·ª≠a
      if (hasHalfStar) {
        stars += '<i class="fas fa-star-half-alt"></i>';
      }
      
      // Sao r·ªóng
      for (let i = 0; i < emptyStars; i++) {
        stars += '<i class="far fa-star"></i>';
      }
      
      return stars;
    }
    
    // Load ratings when tour is loaded
    window.loadTourRatings = loadTourRatings;
    
    // Function to setup navbar scroll effect
    function setupNavbarScrollEffect() {
      window.addEventListener('scroll', function() {
        const navbar = document.querySelector('.navbar');
        if (navbar) {
          if (window.scrollY > 50) {
            navbar.classList.add('scrolled');
          } else {
            navbar.classList.remove('scrolled');
          }
        }
      });
    }
    
    // Function to load related tours
    async function loadRelatedTours(currentTourId) {
      try {
        const response = await fetch(`${window.API_URL}/tours?limit=3`);
        if (!response.ok) {
          throw new Error('Kh√¥ng th·ªÉ t·∫£i tour li√™n quan');
        }
        
        const data = await response.json();
        const relatedToursContainer = document.getElementById('related-tours');
        
        if (data.status === 'success' && data.data.tours) {
          const tours = data.data.tours.filter(tour => tour.Ma_tour !== currentTourId).slice(0, 3);
          
          if (tours.length === 0) {
            relatedToursContainer.innerHTML = '<p class="text-muted">Ch∆∞a c√≥ tour li√™n quan</p>';
            return;
          }
          
          let html = '';
          tours.forEach(tour => {
            let imageUrl = 'images/tour-placeholder.jpg';
            if (tour.Hinh_anh) {
              if (tour.Hinh_anh.startsWith('http')) {
                imageUrl = tour.Hinh_anh;
              } else {
                const baseUrl = window.API_URL.replace('/api', '');
                const imagePath = tour.Hinh_anh.startsWith('/') ? tour.Hinh_anh : '/' + tour.Hinh_anh;
                if (!imagePath.includes('/images/')) {
                  imageUrl = `${baseUrl}/images${imagePath}`;
                } else {
                  imageUrl = `${baseUrl}${imagePath}`;
                }
              }
            }
            
            html += `
              <div class="col-md-4 mb-3">
                <div class="related-tour-card">
                  <img src="${imageUrl}" alt="${tour.Ten_tour}" class="related-tour-image" onerror="this.src='images/tour-placeholder.jpg'">
                  <div class="related-tour-content">
                    <h6 class="related-tour-title">${tour.Ten_tour}</h6>
                    <div class="related-tour-rating mb-2">
                      <i class="fas fa-star text-warning"></i>
                      <i class="fas fa-star text-warning"></i>
                      <i class="fas fa-star text-warning"></i>
                      <i class="fas fa-star text-warning"></i>
                      <i class="fas fa-star text-warning"></i>
                    </div>
                    <div class="related-tour-price">
                      <a href="detailtour.html?tour=${tour.Ma_tour}">${formatCurrency(tour.Gia_nguoi_lon || 0)}</a>
                    </div>
                  </div>
                </div>
              </div>
            `;
          });
          
          relatedToursContainer.innerHTML = html;
        } else {
          relatedToursContainer.innerHTML = '<p class="text-muted">Ch∆∞a c√≥ tour li√™n quan</p>';
        }
      } catch (error) {
        console.error('L·ªói khi t·∫£i tour li√™n quan:', error);
        const relatedToursContainer = document.getElementById('related-tours');
        if (relatedToursContainer) {
          relatedToursContainer.innerHTML = '<p class="text-muted">Kh√¥ng th·ªÉ t·∫£i tour li√™n quan</p>';
        }
      }
    }
    
    // Update rating display when ratings are loaded
    const originalLoadTourRatings = loadTourRatings;
    loadTourRatings = async function(tourId) {
      await originalLoadTourRatings(tourId);
      
      // Update rating score and count in summary section
      try {
        const response = await fetch(`${CONFIG.API_BASE_URL}/ratings/tour/${tourId}`);
        if (response.ok) {
          const data = await response.json();
          if (data.status === 'success' && data.data.averageRating) {
            const ratingScore = document.getElementById('tour-rating-score');
            const ratingCount = document.getElementById('tour-rating-count');
            
            if (ratingScore) {
              ratingScore.textContent = parseFloat(data.data.averageRating).toFixed(1);
            }
            
            if (ratingCount) {
              const totalRatings = data.data.ratings ? data.data.ratings.length : 0;
              ratingCount.textContent = `${totalRatings}+ ƒë√°nh gi√°`;
            }
          }
        }
      } catch (error) {
        console.error('L·ªói khi c·∫≠p nh·∫≠t rating:', error);
      }
    };
    
    // H√†m hi·ªÉn th·ªã modal th√¥ng tin HDV
    function showGuideModal() {
      const schedule = window.currentScheduleGuide;
      if (!schedule || !schedule.Ma_huong_dan_vien || !schedule.Ten_huong_dan_vien) {
        alert('Ch∆∞a c√≥ th√¥ng tin h∆∞·ªõng d·∫´n vi√™n');
        return;
      }
      
      // Debug: log d·ªØ li·ªáu ƒë·ªÉ ki·ªÉm tra
      console.log('üîç Guide data from schedule:', {
        Ma_huong_dan_vien: schedule.Ma_huong_dan_vien,
        Ten_huong_dan_vien: schedule.Ten_huong_dan_vien,
        guide_avg_rating: schedule.guide_avg_rating,
        guide_rating_count: schedule.guide_rating_count,
        guide_avatar: schedule.guide_avatar
      });
      
      // X·ª≠ l√Ω rating - chuy·ªÉn ƒë·ªïi sang number v√† ki·ªÉm tra
      let avgRating = 0;
      let ratingCount = 0;
      
      if (schedule.guide_avg_rating !== null && schedule.guide_avg_rating !== undefined) {
        avgRating = parseFloat(schedule.guide_avg_rating);
        if (isNaN(avgRating)) avgRating = 0;
      }
      
      if (schedule.guide_rating_count !== null && schedule.guide_rating_count !== undefined) {
        ratingCount = parseInt(schedule.guide_rating_count);
        if (isNaN(ratingCount)) ratingCount = 0;
      }
      
      console.log('üìä Processed rating:', { avgRating, ratingCount });
      
      const stars = Math.round(avgRating);
      const starIcons = '‚òÖ'.repeat(stars) + '‚òÜ'.repeat(5 - stars);
      
      // X·ª≠ l√Ω ·∫£nh ƒë·∫°i di·ªán
      let avatarUrl = schedule.guide_avatar;
      const defaultAvatarSvg = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="150" height="150"%3E%3Crect fill="%23ddd" width="150" height="150"/%3E%3Ctext fill="%23999" font-family="sans-serif" font-size="50" dy="10.5" font-weight="bold" x="50%25" y="50%25" text-anchor="middle"%3E%3F%3C/text%3E%3C/svg%3E';
      
      if (!avatarUrl || avatarUrl === null || avatarUrl === '') {
        avatarUrl = defaultAvatarSvg;
      } else {
        // X·ª≠ l√Ω ƒë∆∞·ªùng d·∫´n ·∫£nh
        if (!avatarUrl.startsWith('http') && !avatarUrl.startsWith('data:')) {
          if (avatarUrl.startsWith('/uploads')) {
            avatarUrl = '/images' + avatarUrl;
          } else if (!avatarUrl.startsWith('/images')) {
            avatarUrl = '/images/' + avatarUrl;
          }
          // S·ª≠a l·ªói duplicate /images
          if (avatarUrl.startsWith('/images/images/')) {
            avatarUrl = avatarUrl.replace('/images/images/', '/images/');
          }
          // Th√™m base URL n·∫øu c·∫ßn
          if (!avatarUrl.startsWith('http')) {
            const baseUrl = window.location.origin;
            avatarUrl = baseUrl + avatarUrl;
          }
        }
      }
      
      // Escape HTML ƒë·ªÉ tr√°nh l·ªói syntax
      const escapeHtml = (str) => {
        if (!str) return '';
        return String(str)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      };
      
      const escapedAvatarUrl = escapeHtml(avatarUrl);
      const escapedGuideName = escapeHtml(schedule.Ten_huong_dan_vien);
      
      // T·∫°o modal HTML
      const modalHtml = `
        <div class="modal fade" id="guideInfoModal" tabindex="-1" aria-labelledby="guideInfoModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="guideInfoModalLabel">
                  <i class="fas fa-user-tie me-2"></i>Th√¥ng tin H∆∞·ªõng d·∫´n vi√™n
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body text-center">
                <div class="mb-3">
                  <img id="guideModalAvatar" 
                       src="${escapedAvatarUrl}" 
                       alt="${escapedGuideName}" 
                       class="img-fluid rounded-circle" 
                       style="width: 150px; height: 150px; object-fit: cover; border: 3px solid #007bff;">
                </div>
                <h4 class="mb-3">${escapedGuideName}</h4>
                ${avgRating > 0 && ratingCount > 0 ? `
                  <div class="mb-3">
                    <div class="star-rating text-warning mb-2" style="font-size: 1.5rem;">${starIcons}</div>
                    <div>
                      <span class="h5 fw-bold">${avgRating.toFixed(1)}</span>
                      <span class="text-muted">/ 5.0</span>
                      ${ratingCount > 0 ? `<span class="text-muted ms-2">(${ratingCount} ${ratingCount === 1 ? 'ƒë√°nh gi√°' : 'ƒë√°nh gi√°'})</span>` : ''}
                    </div>
                  </div>
                ` : `
                  <div class="mb-3">
                    <p class="text-muted"><i class="fas fa-info-circle me-2"></i>Ch∆∞a c√≥ ƒë√°nh gi√°</p>
                  </div>
                `}
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // X√≥a modal c≈© n·∫øu c√≥
      const existingModal = document.getElementById('guideInfoModal');
      if (existingModal) {
        existingModal.remove();
      }
      
      // Th√™m modal m·ªõi v√†o body
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      
      // Set onerror handler sau khi element ƒë∆∞·ª£c t·∫°o
      const avatarImg = document.getElementById('guideModalAvatar');
      if (avatarImg) {
        avatarImg.onerror = function() {
          this.src = defaultAvatarSvg;
        };
      }
      
      // Hi·ªÉn th·ªã modal
      const modal = new bootstrap.Modal(document.getElementById('guideInfoModal'));
      modal.show();
      
      // X√≥a modal khi ƒë√≥ng
      document.getElementById('guideInfoModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
      });
    }
  </script>
</body>
</html>