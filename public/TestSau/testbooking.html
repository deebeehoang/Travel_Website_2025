<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Đặt Tour - VietTravel</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">
  <!-- SweetAlert2 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css">
  <!-- Custom CSS -->
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <!-- Navigation -->
  <div id="navbar-container"></div>

  <!-- Main Content -->
  <div class="container my-5">
    <div class="row">
      <div class="col-md-8">
        <div class="card mb-4 shadow-sm">
          <div class="card-body">
            <h3 class="card-title mb-4">Thông tin đặt tour</h3>
            <div id="tourInfo" class="mb-4">
              <div class="placeholder-glow mb-3">
                <div class="placeholder col-12 rounded" style="height: 150px;"></div>
              </div>
              <h4 class="placeholder col-6"></h4>
              <p class="placeholder col-8"></p>
              <div class="placeholder col-4"></div>
            </div>

            <form id="bookingForm">
              <input type="hidden" name="ma_tour" id="ma_tour">
              <input type="hidden" name="ma_lich_khoi_hanh" id="ma_lich_khoi_hanh">
              
              <div class="mb-3">
                <label class="form-label">Số người lớn</label>
                <input type="number" class="form-control booking-count" id="so_nguoi_lon" name="so_nguoi_lon" min="1" value="1" required>
              </div>
              
              <div class="mb-3">
                <label class="form-label">Số trẻ em</label>
                <input type="number" class="form-control booking-count" id="so_tre_em" name="so_tre_em" min="0" value="0">
              </div>

              <div class="mb-3">
                <label class="form-label">Mã khuyến mãi (nếu có)</label>
                <input type="text" class="form-control" id="ma_khuyen_mai" name="ma_khuyen_mai">
              </div>

              <div id="extraServices" class="mb-4">
                <!-- Dịch vụ bổ sung sẽ được load động ở đây -->
                <div class="text-center py-3">
                  <div class="spinner-border text-primary"></div>
                  <p class="mt-2">Đang tải dịch vụ...</p>
                </div>
              </div>

              <button type="submit" class="btn btn-primary btn-lg w-100">Đặt tour</button>
            </form>
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card shadow-sm sticky-top" style="top: 20px">
          <div class="card-body">
            <h4 class="card-title mb-3">Tổng thanh toán</h4>
            <div id="booking-summary">
              <div class="d-flex justify-content-between mb-2">
                <span>Người lớn:</span>
                <span>
                  <span id="adult-count">1</span> x 
                  <span id="adult-price" data-price="1500000">1.500.000 ₫</span>
                </span>
              </div>
              <div class="d-flex justify-content-between mb-2">
                <span>Trẻ em:</span>
                <span>
                  <span id="child-count">0</span> x 
                  <span id="child-price" data-price="1000000">1.000.000 ₫</span>
                </span>
              </div>
              <hr>
              <div class="d-flex justify-content-between">
                <strong>Tổng cộng:</strong>
                <strong id="total-price">1.500.000 ₫</strong>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div id="footer-container"></div>

  <!-- Bootstrap Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>
  
  <!-- Custom Scripts -->
  <script>
    // API URL cho môi trường phát triển
    window.API_URL = 'http://localhost:5000/api';
  </script>
  <script src="js/main.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/client/booking.js"></script>
  
  <script>
    // Script cho trang booking
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('Trang đặt tour đã tải xong');
      
      // Tải navbar và footer
      if (typeof loadNavbar === 'function') loadNavbar();
      if (typeof loadFooter === 'function') loadFooter();
      
      // Lấy thông tin tour từ URL
      const urlParams = new URLSearchParams(window.location.search);
      const tourId = urlParams.get('tour');
      const scheduleId = urlParams.get('schedule');
      
      if (!tourId) {
        Swal.fire({
          icon: 'error',
          title: 'Lỗi',
          text: 'Không tìm thấy thông tin tour',
          confirmButtonText: 'Về trang chủ'
        }).then(() => {
          window.location.href = '/index.html';
        });
        return;
      }
      
      // Thiết lập các giá trị ẩn
      document.getElementById('ma_tour').value = tourId;
      if (scheduleId) {
        document.getElementById('ma_lich_khoi_hanh').value = scheduleId;
      }
      
      try {
        // Tải thông tin tour
        const response = await fetch(`${window.API_URL}/tours/${tourId}`);
        const data = await response.json();
        
        if (data.status === 'success' && data.data.tour) {
          const tour = data.data.tour;
          
          // Hiển thị thông tin tour
          displayTourInfo(tour);
          
          // Nếu có mã lịch, tải thêm thông tin lịch
          if (scheduleId) {
            await loadScheduleInfo(scheduleId);
          } else {
            // Nếu không có mã lịch, tải lịch gần nhất
            await loadLatestSchedule(tourId);
          }
        } else {
          throw new Error('Không thể tải thông tin tour');
        }
      } catch (error) {
        console.error('Lỗi khi tải thông tin tour:', error);
        Swal.fire({
          icon: 'error',
          title: 'Lỗi',
          text: 'Không thể tải thông tin tour',
          confirmButtonText: 'Thử lại'
        });
      }
    });
    
    // Hiển thị thông tin tour
    function displayTourInfo(tour) {
      const tourInfoContainer = document.getElementById('tourInfo');
      tourInfoContainer.innerHTML = `
        <div class="mb-3">
          <img src="${tour.Hinh_anh ? tour.Hinh_anh : 'img/placeholder.jpg'}" class="img-fluid rounded" alt="${tour.Ten_tour}">
        </div>
        <h4 class="mb-2">${tour.Ten_tour}</h4>
        <p class="text-muted mb-2">
          <i class="fas fa-map-marker-alt me-1"></i> ${tour.Diem_den || 'Chưa cập nhật'}
        </p>
        <div class="mb-3">
          <span class="badge bg-info me-1">
            <i class="fas fa-clock me-1"></i>${tour.So_ngay || '?'} ngày ${tour.So_dem || '?'} đêm
          </span>
          <span class="badge bg-success">
            <i class="fas fa-users me-1"></i>${tour.So_cho || '?'} chỗ
          </span>
        </div>
      `;
    }
    
    // Tải thông tin lịch khởi hành
    async function loadScheduleInfo(scheduleId) {
      try {
        const response = await fetch(`${window.API_URL}/schedules/${scheduleId}`);
        const data = await response.json();
        
        if (data.status === 'success' && data.data.schedule) {
          updatePriceInfo(data.data.schedule);
        }
      } catch (error) {
        console.error('Lỗi khi tải thông tin lịch trình:', error);
      }
    }
    
    // Tải lịch khởi hành gần nhất
    async function loadLatestSchedule(tourId) {
      try {
        const response = await fetch(`${window.API_URL}/tours/${tourId}/upcoming-schedules`);
        const data = await response.json();
        
        if (data.status === 'success' && data.data.schedules && data.data.schedules.length > 0) {
          const latestSchedule = data.data.schedules[0];
          document.getElementById('ma_lich_khoi_hanh').value = latestSchedule.Ma_lich;
          updatePriceInfo(latestSchedule);
        }
      } catch (error) {
        console.error('Lỗi khi tải lịch trình gần nhất:', error);
      }
    }
    
    // Cập nhật thông tin giá
    function updatePriceInfo(schedule) {
      const adultPrice = schedule.Gia_nguoi_lon || 1500000;
      const childPrice = schedule.Gia_tre_em || 1000000;
      
      const adultPriceEl = document.getElementById('adult-price');
      const childPriceEl = document.getElementById('child-price');
      
      adultPriceEl.dataset.price = adultPrice;
      childPriceEl.dataset.price = childPrice;
      
      adultPriceEl.textContent = formatCurrency(adultPrice);
      childPriceEl.textContent = formatCurrency(childPrice);
      
      // Cập nhật tổng tiền
      updateTotalPriceDisplay();
    }
    
    // Cập nhật hiển thị tổng tiền
    function updateTotalPriceDisplay() {
      const adultPrice = parseFloat(document.getElementById('adult-price').dataset.price);
      const childPrice = parseFloat(document.getElementById('child-price').dataset.price);
      const adultCount = parseInt(document.getElementById('so_nguoi_lon').value);
      const childCount = parseInt(document.getElementById('so_tre_em').value);
      
      document.getElementById('adult-count').textContent = adultCount;
      document.getElementById('child-count').textContent = childCount;
      
      const totalPrice = (adultPrice * adultCount) + (childPrice * childCount);
      document.getElementById('total-price').textContent = formatCurrency(totalPrice);
    }
    
    // Định dạng tiền tệ
    function formatCurrency(amount) {
      return new Intl.NumberFormat('vi-VN', {
        style: 'currency',
        currency: 'VND'
      }).format(amount);
    }
    
    // Cập nhật tổng tiền khi thay đổi số lượng người
    document.querySelectorAll('.booking-count').forEach(input => {
      input.addEventListener('change', updateTotalPriceDisplay);
    });
  </script>
</body>
</html>