<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Đánh Giá - VietTravel Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
        }
        
        .admin-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
        }
        
        .stats-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            transition: transform 0.3s;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
        }
        
        .stats-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 15px;
        }
        
        .stats-number {
            font-size: 32px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .stats-label {
            color: #6c757d;
            font-size: 14px;
            font-weight: 500;
        }
        
        .rating-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .rating-header {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: between;
            align-items: center;
        }
        
        .rating-content {
            padding: 20px;
        }
        
        .rating-stars {
            color: #ffc107;
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .rating-text {
            color: #495057;
            line-height: 1.6;
            margin-bottom: 15px;
        }
        
        .rating-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: #6c757d;
        }
        
        .rating-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-rating {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-edit {
            background: #17a2b8;
            color: white;
        }
        
        .btn-edit:hover {
            background: #138496;
            transform: translateY(-2px);
        }
        
        .btn-delete {
            background: #dc3545;
            color: white;
        }
        
        .btn-delete:hover {
            background: #c82333;
            transform: translateY(-2px);
        }
        
        .btn-delete-all {
            background: #e74c3c;
            color: white;
        }
        
        .btn-delete-all:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }
        
        .filter-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .filter-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
        }
        
        .filter-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-select {
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            background: white;
            color: #495057;
            font-size: 14px;
            min-width: 150px;
        }
        
        .filter-select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }
        
        .search-box {
            flex: 1;
            min-width: 200px;
        }
        
        .search-input {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            background: white;
            color: #495057;
            font-size: 14px;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }
        
        .loading-spinner {
            text-align: center;
            padding: 50px;
        }
        
        .no-ratings {
            text-align: center;
            padding: 50px;
            color: #6c757d;
        }
        
        .rating-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .back-btn {
            background: #6c757d;
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            text-decoration: none;
            display: inline-block;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        
        .back-btn:hover {
            background: #5a6268;
            color: white;
            text-decoration: none;
        }
        
        .pagination {
            justify-content: center;
            margin-top: 30px;
        }
        
        .page-link {
            border-radius: 10px;
            margin: 0 5px;
            border: 2px solid #e9ecef;
            color: #495057;
        }
        
        .page-link:hover {
            background: #007bff;
            border-color: #007bff;
            color: white;
        }
        
        .page-item.active .page-link {
            background: #007bff;
            border-color: #007bff;
        }
    </style>
</head>
<body>
    <div class="admin-header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="fas fa-star"></i> Quản Lý Đánh Giá Tour</h2>
                    <p class="mb-0">Theo dõi và quản lý đánh giá từ khách hàng</p>
                </div>
                <a href="admin.html" class="back-btn">
                    <i class="fas fa-arrow-left"></i> Quay lại Admin
                </a>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Thống kê tổng quan -->
        <div class="rating-stats" id="rating-stats">
            <div class="stats-card">
                <div class="stats-icon" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">
                    <i class="fas fa-star"></i>
                </div>
                <div class="stats-number" id="total-ratings">0</div>
                <div class="stats-label">Tổng đánh giá</div>
            </div>
            
            <div class="stats-card">
                <div class="stats-icon" style="background: linear-gradient(135deg, #f093fb, #f5576c); color: white;">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="stats-number" id="average-rating">0.0</div>
                <div class="stats-label">Điểm trung bình</div>
            </div>
            
            <div class="stats-card">
                <div class="stats-icon" style="background: linear-gradient(135deg, #4facfe, #00f2fe); color: white;">
                    <i class="fas fa-thumbs-up"></i>
                </div>
                <div class="stats-number" id="five-star-count">0</div>
                <div class="stats-label">5 sao</div>
            </div>
            
            <div class="stats-card">
                <div class="stats-icon" style="background: linear-gradient(135deg, #43e97b, #38f9d7); color: white;">
                    <i class="fas fa-trophy"></i>
                </div>
                <div class="stats-number" id="top-tours">0</div>
                <div class="stats-label">Tour nổi bật</div>
            </div>
        </div>

        <!-- Bộ lọc -->
        <div class="filter-section">
            <div class="filter-title">
                <i class="fas fa-filter"></i> Bộ lọc và tìm kiếm
            </div>
            <div class="filter-group">
                <select class="filter-select" id="tour-filter">
                    <option value="">Tất cả tour</option>
                </select>
                
                <select class="filter-select" id="rating-filter">
                    <option value="">Tất cả số sao</option>
                    <option value="5">5 sao</option>
                    <option value="4">4 sao</option>
                    <option value="3">3 sao</option>
                    <option value="2">2 sao</option>
                    <option value="1">1 sao</option>
                </select>
                
                <select class="filter-select" id="sort-filter">
                    <option value="newest">Mới nhất</option>
                    <option value="oldest">Cũ nhất</option>
                    <option value="highest">Điểm cao nhất</option>
                    <option value="lowest">Điểm thấp nhất</option>
                </select>
                
                <div class="search-box">
                    <input type="text" class="search-input" id="search-input" placeholder="Tìm kiếm theo tên khách hàng hoặc nội dung...">
                </div>
                
                <button class="btn btn-primary" onclick="applyFilters()">
                    <i class="fas fa-search"></i> Lọc
                </button>
                
                <button class="btn btn-outline-secondary" onclick="clearFilters()">
                    <i class="fas fa-times"></i> Xóa bộ lọc
                </button>
            </div>
        </div>

        <!-- Danh sách đánh giá -->
        <div id="ratings-container">
            <div class="loading-spinner" id="loading-spinner">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Đang tải...</span>
                </div>
                <p class="mt-2">Đang tải danh sách đánh giá...</p>
            </div>
            
            <div class="no-ratings d-none" id="no-ratings">
                <i class="fas fa-star" style="font-size: 48px; color: #dee2e6; margin-bottom: 20px;"></i>
                <h5>Chưa có đánh giá nào</h5>
                <p>Khách hàng chưa đánh giá tour nào.</p>
            </div>
            
            <div id="ratings-list" class="d-none">
                <!-- Danh sách đánh giá sẽ được tải động -->
            </div>
        </div>

        <!-- Phân trang -->
        <nav aria-label="Phân trang đánh giá" id="pagination-container" class="d-none">
            <ul class="pagination">
                <!-- Phân trang sẽ được tạo động -->
            </ul>
        </nav>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script>
        let currentPage = 1;
        let totalPages = 1;
        let currentFilters = {
            rating: '',
            tour: '',
            sort: 'newest',
            search: ''
        };

        // Khởi tạo trang
        document.addEventListener('DOMContentLoaded', function() {
            checkAdminAuth();
            loadRatingStats();
            loadToursForFilter();
            loadRatings();
            setupEventListeners();
        });

        // Kiểm tra quyền admin
        function checkAdminAuth() {
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user') ? JSON.parse(localStorage.getItem('user')) : null;
            
            if (!token || !user || (user.loai_tai_khoan !== 'Admin' && user.role !== 'Admin')) {
                window.location.href = 'login.html';
            }
        }

        // Thiết lập event listeners
        function setupEventListeners() {
            document.getElementById('rating-filter').addEventListener('change', function() {
                currentFilters.rating = this.value;
                currentPage = 1;
                loadRatings();
            });

            document.getElementById('tour-filter').addEventListener('change', function() {
                currentFilters.tour = this.value;
                currentPage = 1;
                loadRatings();
            });

            document.getElementById('sort-filter').addEventListener('change', function() {
                currentFilters.sort = this.value;
                currentPage = 1;
                loadRatings();
            });

            document.getElementById('search-input').addEventListener('input', function() {
                currentFilters.search = this.value;
                // Debounce search
                clearTimeout(this.searchTimeout);
                this.searchTimeout = setTimeout(() => {
                    currentPage = 1;
                    loadRatings();
                }, 500);
            });
        }

        // Tải thống kê đánh giá
        async function loadRatingStats() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/api/ratings/stats`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.status === 'success') {
                        const stats = result.data.overallStats;
                        document.getElementById('total-ratings').textContent = stats.total_ratings || 0;
                        document.getElementById('average-rating').textContent = parseFloat(stats.average_rating || 0).toFixed(1);
                        document.getElementById('five-star-count').textContent = stats.five_star || 0;
                        document.getElementById('top-tours').textContent = result.data.topRatedTours ? result.data.topRatedTours.length : 0;
                    }
                }
            } catch (error) {
                console.error('Lỗi khi tải thống kê:', error);
            }
        }

        // Tải danh sách tour cho bộ lọc
        async function loadToursForFilter() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/api/tours`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.status === 'success') {
                        const tourSelect = document.getElementById('tour-filter');
                        result.data.tours.forEach(tour => {
                            const option = document.createElement('option');
                            option.value = tour.Ma_tour;
                            option.textContent = tour.Ten_tour;
                            tourSelect.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('Lỗi khi tải danh sách tour:', error);
            }
        }

        // Tải danh sách đánh giá
        async function loadRatings() {
            try {
                document.getElementById('loading-spinner').classList.remove('d-none');
                document.getElementById('ratings-list').classList.add('d-none');
                document.getElementById('no-ratings').classList.add('d-none');
                document.getElementById('pagination-container').classList.add('d-none');

                const token = localStorage.getItem('token');
                // Sử dụng endpoint /all với authentication
                let url = `${API_BASE_URL}/api/ratings/all`;
                const queryParams = [];
                
                // Thêm bộ lọc vào URL - ưu tiên tour filter
                if (currentFilters.tour) {
                    queryParams.push(`tour=${currentFilters.tour}`);
                }
                if (currentFilters.rating) {
                    queryParams.push(`rating=${currentFilters.rating}`);
                }
                if (currentFilters.sort) {
                    queryParams.push(`sort=${currentFilters.sort}`);
                }
                if (currentFilters.search) {
                    queryParams.push(`search=${encodeURIComponent(currentFilters.search)}`);
                }
                
                if (queryParams.length > 0) {
                    url += '?' + queryParams.join('&');
                }

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.status === 'success') {
                        displayRatings(result.data.ratings);
                        if (result.data.ratings.length === 0) {
                            document.getElementById('no-ratings').classList.remove('d-none');
                        }
                    }
                } else {
                    throw new Error('Không thể tải danh sách đánh giá');
                }
            } catch (error) {
                console.error('Lỗi khi tải đánh giá:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi',
                    text: 'Không thể tải danh sách đánh giá',
                    confirmButtonText: 'Đóng'
                });
            } finally {
                document.getElementById('loading-spinner').classList.add('d-none');
            }
        }

        // Hiển thị danh sách đánh giá
        function displayRatings(ratings) {
            const container = document.getElementById('ratings-list');
            container.innerHTML = '';

            ratings.forEach(rating => {
                const ratingCard = createRatingCard(rating);
                container.innerHTML += ratingCard;
            });

            document.getElementById('ratings-list').classList.remove('d-none');
        }

        // Tạo card đánh giá
        function createRatingCard(rating) {
            const stars = '★'.repeat(rating.So_sao) + '☆'.repeat(5 - rating.So_sao);
            const ratingDate = new Date(rating.Ngay_danh_gia).toLocaleDateString('vi-VN');
            
            return `
                <div class="rating-card">
                    <div class="rating-header">
                        <div>
                            <h6 class="mb-1">${rating.Ten_khach_hang || 'Khách hàng'}</h6>
                            <small class="text-muted">Tour: ${rating.Ten_tour || 'N/A'}</small>
                        </div>
                        <div class="rating-actions">
                            <button class="btn-rating btn-edit" onclick="editRating('${rating.Id_review}')" title="Sửa đánh giá">
                                <i class="fas fa-edit"></i> Sửa
                            </button>
                            <button class="btn-rating btn-delete" onclick="deleteRating('${rating.Id_review}')" title="Xóa đánh giá này">
                                <i class="fas fa-trash"></i> Xóa
                            </button>
                            ${rating.Ma_tour ? `
                                <button class="btn-rating btn-delete-all" onclick="deleteRatingsByTour('${rating.Ma_tour}', '${(rating.Ten_tour || 'tour này').replace(/'/g, "\\'")}')" title="Xóa tất cả đánh giá của tour ${(rating.Ten_tour || 'này').replace(/'/g, "\\'")}">
                                    <i class="fas fa-trash-alt"></i> Xóa theo tour
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    <div class="rating-content">
                        <div class="rating-stars">${stars}</div>
                        <div class="rating-text">${rating.Binh_luan || 'Không có nhận xét'}</div>
                        <div class="rating-meta">
                            <span><i class="fas fa-calendar"></i> ${ratingDate}</span>
                            <span><i class="fas fa-receipt"></i> Booking: ${rating.Ma_booking || 'N/A'}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // Áp dụng bộ lọc
        function applyFilters() {
            currentPage = 1;
            loadRatings();
        }

        // Xóa bộ lọc
        function clearFilters() {
            document.getElementById('rating-filter').value = '';
            document.getElementById('tour-filter').value = '';
            document.getElementById('sort-filter').value = 'newest';
            document.getElementById('search-input').value = '';
            
            currentFilters = {
                rating: '',
                tour: '',
                sort: 'newest',
                search: ''
            };
            
            currentPage = 1;
            loadRatings();
        }

        // Sửa đánh giá
        function editRating(ratingId) {
            Swal.fire({
                title: 'Sửa đánh giá',
                text: 'Chức năng này sẽ được phát triển trong phiên bản tiếp theo',
                icon: 'info',
                confirmButtonText: 'Đóng'
            });
        }

        // Xóa đánh giá riêng lẻ
        async function deleteRating(ratingId) {
            const result = await Swal.fire({
                title: 'Xác nhận xóa',
                text: 'Bạn có chắc chắn muốn xóa đánh giá này?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Xóa',
                cancelButtonText: 'Hủy',
                confirmButtonColor: '#dc3545'
            });

            if (result.isConfirmed) {
                try {
                    const token = localStorage.getItem('token');
                    const response = await fetch(`${API_BASE_URL}/api/ratings/${ratingId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    const data = await response.json();

                    if (response.ok && data.status === 'success') {
                        Swal.fire({
                            icon: 'success',
                            title: 'Thành công',
                            text: 'Đánh giá đã được xóa',
                            confirmButtonText: 'Đóng'
                        });
                        loadRatings();
                        loadRatingStats();
                    } else {
                        throw new Error(data.message || 'Không thể xóa đánh giá');
                    }
                } catch (error) {
                    console.error('Lỗi khi xóa đánh giá:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi',
                        text: error.message || 'Không thể xóa đánh giá',
                        confirmButtonText: 'Đóng'
                    });
                }
            }
        }

        // Xóa tất cả đánh giá của một tour
        async function deleteRatingsByTour(tourId, tourName) {
            const result = await Swal.fire({
                title: 'Xác nhận xóa',
                html: `Bạn có chắc chắn muốn xóa <strong>TẤT CẢ</strong> đánh giá của tour <strong>"${tourName}"</strong>?<br><br>
                       <span class="text-danger"><i class="fas fa-exclamation-triangle"></i> Hành động này không thể hoàn tác!</span>`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Xóa tất cả',
                cancelButtonText: 'Hủy',
                confirmButtonColor: '#dc3545',
                width: '500px'
            });

            if (result.isConfirmed) {
                try {
                    const token = localStorage.getItem('token');
                    const response = await fetch(`${API_BASE_URL}/api/ratings/tour/${tourId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    const data = await response.json();

                    if (response.ok && data.status === 'success') {
                        Swal.fire({
                            icon: 'success',
                            title: 'Thành công',
                            text: data.message || `Đã xóa ${data.data?.deletedCount || 0} đánh giá`,
                            confirmButtonText: 'Đóng'
                        });
                        loadRatings();
                        loadRatingStats();
                    } else {
                        throw new Error(data.message || 'Không thể xóa đánh giá');
                    }
                } catch (error) {
                    console.error('Lỗi khi xóa đánh giá theo tour:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi',
                        text: error.message || 'Không thể xóa đánh giá',
                        confirmButtonText: 'Đóng'
                    });
                }
            }
        }
    </script>
</body>
</html>
